# Балансировка нагрузки: воркеры могут подключаться к loadbalancer (порт 8080).
# Балансировщик распределяет запросы по узлам (ip_hash: один воркер = один узел, разные воркеры — на разные узлы).
# Фиксированное имя проекта: образ и сеть всегда distributed-compute_*, автозапуск воркера работает без .env
name: distributed-compute

services:
  # 1. Узел 1 (децентрализованный оркестратор)
  orchestrator_node_1:
    build:
      context: .
      dockerfile: orchestrator_node/Dockerfile
    ports:
      - "5000:5000"
    container_name: orchestrator_node_1
    volumes:
      # Для автозапуска воркера из интерфейса (POST /run_worker)
      - /var/run/docker.sock:/var/run/docker.sock
      # Постоянное хранение аккаунтов (users.json) и данных авторизации
      - ./orchestrator_node/data:/app/data
    environment:
      - PEER_URL=http://orchestrator_node_2:5000
      - SYNC_INTERVAL=30
      # Секрет для запросов между узлами (receive_block, receive_chain) — обязателен.
      - NODE_SECRET=${NODE_SECRET:?NODE_SECRET is required}
      # Bootstrap первого поставщика: его аккаунт используется для мигрированных базовых контрактов
      - BOOTSTRAP_PROVIDER_LOGIN=${BOOTSTRAP_PROVIDER_LOGIN:-first_provider}
      - BOOTSTRAP_PROVIDER_PASSWORD=${BOOTSTRAP_PROVIDER_PASSWORD:-first_provider_change_me}
      - BOOTSTRAP_PROVIDER_NICKNAME=${BOOTSTRAP_PROVIDER_NICKNAME:-Первый поставщик}
      # Решение централизации: идентификатор узла для ротации лидера
      - NODE_ID=node-1
      - NODE_IDS=node-1,node-2
      # Автозапуск воркера из интерфейса (имя образа: у Docker Compose v2 может быть дефис project-service)
      - WORKER_IMAGE=distributed-compute-client_worker_1
      # Воркер, запущенный с node_1, работает через node_1.
      - ORCHESTRATOR_URL_FOR_WORKER=http://orchestrator_node_1:5000
      - DOCKER_NETWORK=distributed-compute_default
    # Для TLS задайте TLS_CERT_FILE, TLS_KEY_FILE и смонтируйте сертификаты
    # restart: unless-stopped

  # 2. Узел 2 (децентрализованный оркестратор, равноправный с узлом 1)
  orchestrator_node_2:
    build:
      context: .
      dockerfile: orchestrator_node/Dockerfile
    ports:
      - "5001:5000"
    container_name: orchestrator_node_2
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./orchestrator_node/data:/app/data
    environment:
      - PEER_URL=http://orchestrator_node_1:5000
      - SYNC_INTERVAL=30
      - NODE_SECRET=${NODE_SECRET:?NODE_SECRET is required}
      - BOOTSTRAP_PROVIDER_LOGIN=${BOOTSTRAP_PROVIDER_LOGIN:-first_provider}
      - BOOTSTRAP_PROVIDER_PASSWORD=${BOOTSTRAP_PROVIDER_PASSWORD:-first_provider_change_me}
      - BOOTSTRAP_PROVIDER_NICKNAME=${BOOTSTRAP_PROVIDER_NICKNAME:-Первый поставщик}
      - NODE_ID=node-2
      - NODE_IDS=node-1,node-2
      - WORKER_IMAGE=distributed-compute-client_worker_1
      # Воркер, запущенный с node_2, работает через node_2 (для симметричной децентрализации).
      - ORCHESTRATOR_URL_FOR_WORKER=http://orchestrator_node_2:5000
      - DOCKER_NETWORK=distributed-compute_default
    depends_on:
      - orchestrator_node_1
    # restart: unless-stopped

  # 2b. Узел 3 (для горизонтального масштабирования; опционально: раскомментируйте и добавьте в nginx upstream)
  # orchestrator_node_3:
  #   build:
  #     context: ./orchestrator_node
  #   ports:
  #     - "5002:5000"
  #   container_name: orchestrator_node_3
  #   environment:
  #     - PEER_URL=http://orchestrator_node_1:5000
  #     - SYNC_INTERVAL=30
  #     - NODE_SECRET=${NODE_SECRET:?NODE_SECRET is required}
  #   depends_on:
  #     - orchestrator_node_1
  #   # restart: unless-stopped

  # 3. Клиент-вычислитель 1 (подключается к узлу 1).
  # Профиль "workers": не стартует при обычном docker-compose up -d, только при docker-compose --profile workers up -d.
  # Рекомендуется запускать воркеры из интерфейса («Запустить воркер») — тогда будет один контракт и нужный вычислитель.
  client_worker_1:
    profiles:
      - workers
    build:
      context: .
      dockerfile: client_worker/Dockerfile
    container_name: client_worker_1
    environment:
      - ORCHESTRATOR_URL=http://orchestrator_node_1:5000
      - CONTRACT_ID=${CONTRACT_ID:-}
    depends_on:
      - orchestrator_node_1
    # restart: unless-stopped

  # 4. Клиент-вычислитель 2 (подключается к узлу 2). То же: профиль workers, не стартует по умолчанию.
  client_worker_2:
    profiles:
      - workers
    build:
      context: .
      dockerfile: client_worker/Dockerfile
    container_name: client_worker_2
    environment:
      - ORCHESTRATOR_URL=http://orchestrator_node_2:5000
      - CONTRACT_ID=${CONTRACT_ID:-}
    depends_on:
      - orchestrator_node_2
    # restart: unless-stopped

  # 5. Балансировщик нагрузки: воркеры в Docker — ORCHESTRATOR_URL=http://loadbalancer (порт 80); с хоста — http://localhost:8080
  loadbalancer:
    image: nginx:alpine
    container_name: loadbalancer
    ports:
      - "8080:80"
    volumes:
      - ./nginx_loadbalancer/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - orchestrator_node_1
      - orchestrator_node_2
    # restart: unless-stopped
