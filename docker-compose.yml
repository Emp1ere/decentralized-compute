# Балансировка нагрузки: воркеры могут подключаться к loadbalancer (порт 8080).
# Балансировщик распределяет запросы по узлам (ip_hash: один воркер = один узел, разные воркеры — на разные узлы).
version: '3.8'

services:
  # 1. Узел 1 (децентрализованный оркестратор)
  orchestrator_node_1:
    build:
      context: ./orchestrator_node
    ports:
      - "5000:5000"
    container_name: orchestrator_node_1
    environment:
      - PEER_URL=http://orchestrator_node_2:5000
      - SYNC_INTERVAL=30
      # Секрет для запросов между узлами (receive_block, receive_chain) — задайте свой в продакшене
      - NODE_SECRET=${NODE_SECRET:-node-secret-change-me}
    # Для TLS задайте TLS_CERT_FILE, TLS_KEY_FILE и смонтируйте сертификаты
    # restart: unless-stopped

  # 2. Узел 2 (децентрализованный оркестратор, равноправный с узлом 1)
  orchestrator_node_2:
    build:
      context: ./orchestrator_node
    ports:
      - "5001:5000"
    container_name: orchestrator_node_2
    environment:
      - PEER_URL=http://orchestrator_node_1:5000
      - SYNC_INTERVAL=30
      - NODE_SECRET=${NODE_SECRET:-node-secret-change-me}
    depends_on:
      - orchestrator_node_1
    # restart: unless-stopped

  # 3. Клиент-вычислитель 1 (подключается к узлу 1)
  client_worker_1:
    build:
      context: ./client_worker
    container_name: client_worker_1
    environment:
      - ORCHESTRATOR_URL=http://orchestrator_node_1:5000
    depends_on:
      - orchestrator_node_1
    # restart: unless-stopped

  # 4. Клиент-вычислитель 2 (подключается к узлу 2)
  client_worker_2:
    build:
      context: ./client_worker
    container_name: client_worker_2
    environment:
      - ORCHESTRATOR_URL=http://orchestrator_node_2:5000
    depends_on:
      - orchestrator_node_2
    # restart: unless-stopped

  # 5. Балансировщик нагрузки (опционально): воркеры могут использовать ORCHESTRATOR_URL=http://loadbalancer:8080
  loadbalancer:
    image: nginx:alpine
    container_name: loadbalancer
    ports:
      - "8080:80"
    volumes:
      - ./nginx_loadbalancer/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - orchestrator_node_1
      - orchestrator_node_2
    # restart: unless-stopped
