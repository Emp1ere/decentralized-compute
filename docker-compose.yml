# Балансировка нагрузки: воркеры могут подключаться к loadbalancer (порт 8080).
# Балансировщик распределяет запросы по узлам (ip_hash: один воркер = один узел, разные воркеры — на разные узлы).
version: '3.8'

services:
  # 1. Узел 1 (децентрализованный оркестратор)
  orchestrator_node_1:
    build:
      context: ./orchestrator_node
    ports:
      - "5000:5000"
    container_name: orchestrator_node_1
    volumes:
      # Для автозапуска воркера из интерфейса (POST /run_worker)
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - PEER_URL=http://orchestrator_node_2:5000
      - SYNC_INTERVAL=30
      # Секрет для запросов между узлами (receive_block, receive_chain) — задайте свой в продакшене
      - NODE_SECRET=${NODE_SECRET:-node-secret-change-me}
      # Решение централизации: идентификатор узла для ротации лидера
      - NODE_ID=node-1
      - NODE_IDS=node-1,node-2
      # Автозапуск воркера из интерфейса (имя образа и сеть — при другом имени проекта измените)
      - WORKER_IMAGE=${WORKER_IMAGE:-distributed-compute_client_worker_1}
      - ORCHESTRATOR_URL_FOR_WORKER=http://orchestrator_node_1:5000
      - DOCKER_NETWORK=${DOCKER_NETWORK:-distributed-compute_default}
    # Для TLS задайте TLS_CERT_FILE, TLS_KEY_FILE и смонтируйте сертификаты
    # restart: unless-stopped

  # 2. Узел 2 (децентрализованный оркестратор, равноправный с узлом 1)
  orchestrator_node_2:
    build:
      context: ./orchestrator_node
    ports:
      - "5001:5000"
    container_name: orchestrator_node_2
    environment:
      - PEER_URL=http://orchestrator_node_1:5000
      - SYNC_INTERVAL=30
      - NODE_SECRET=${NODE_SECRET:-node-secret-change-me}
      # Решение централизации: идентификатор узла для ротации лидера
      - NODE_ID=node-2
      - NODE_IDS=node-1,node-2
    depends_on:
      - orchestrator_node_1
    # restart: unless-stopped

  # 2b. Узел 3 (для горизонтального масштабирования; опционально: раскомментируйте и добавьте в nginx upstream)
  # orchestrator_node_3:
  #   build:
  #     context: ./orchestrator_node
  #   ports:
  #     - "5002:5000"
  #   container_name: orchestrator_node_3
  #   environment:
  #     - PEER_URL=http://orchestrator_node_1:5000
  #     - SYNC_INTERVAL=30
  #     - NODE_SECRET=${NODE_SECRET:-node-secret-change-me}
  #   depends_on:
  #     - orchestrator_node_1
  #   # restart: unless-stopped

  # 3. Клиент-вычислитель 1 (подключается к узлу 1)
  client_worker_1:
    build:
      context: ./client_worker
    container_name: client_worker_1
    environment:
      - ORCHESTRATOR_URL=http://orchestrator_node_1:5000
      # Опционально: только задачи по контракту (из интерфейса «Выполнить в воркере»)
      - CONTRACT_ID=${CONTRACT_ID:-}
    depends_on:
      - orchestrator_node_1
    # restart: unless-stopped

  # 4. Клиент-вычислитель 2 (подключается к узлу 2)
  client_worker_2:
    build:
      context: ./client_worker
    container_name: client_worker_2
    environment:
      - ORCHESTRATOR_URL=http://orchestrator_node_2:5000
      - CONTRACT_ID=${CONTRACT_ID:-}
    depends_on:
      - orchestrator_node_2
    # restart: unless-stopped

  # 5. Балансировщик нагрузки: воркеры в Docker — ORCHESTRATOR_URL=http://loadbalancer (порт 80); с хоста — http://localhost:8080
  loadbalancer:
    image: nginx:alpine
    container_name: loadbalancer
    ports:
      - "8080:80"
    volumes:
      - ./nginx_loadbalancer/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - orchestrator_node_1
      - orchestrator_node_2
    # restart: unless-stopped
