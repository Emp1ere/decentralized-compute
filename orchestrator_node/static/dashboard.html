<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Distributed Compute - Узел</title>
  <style>
    :root {
      --bg: #1a1d23;
      --panel: #252830;
      --border: #3d424d;
      --text: #e6e8ec;
      --muted: #8b909a;
      --accent: #5c9ead;
      --success: #7cb342;
      --error: #e57373;
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 12px 20px 24px;
      min-height: 100vh;
    }
    h1 {
      font-size: 1.25rem;
      font-weight: 600;
      margin: 0 0 16px;
      color: var(--accent);
    }
    .tabs {
      display: flex;
      gap: 2px;
      margin-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }
    .tabs button {
      background: transparent;
      border: none;
      color: var(--muted);
      padding: 10px 16px;
      cursor: pointer;
      font-size: 0.95rem;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
    }
    .tabs button:hover { color: var(--text); }
    .tabs button.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }
    .panel {
      display: none;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 20px;
    }
    .panel.active { display: block; }
    .overview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 14px;
    }
    .card .label { color: var(--muted); font-size: 0.85rem; margin-bottom: 4px; }
    .card .value { font-size: 1.5rem; font-weight: 600; }
    .row { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; margin-bottom: 12px; }
    button.primary {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 10px 18px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.95rem;
    }
    button.primary:hover { filter: brightness(1.1); }
    button.primary:disabled { opacity: 0.6; cursor: not-allowed; }
    input[type="text"], input[type="number"], input[type="password"] {
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 6px;
      min-width: 200px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    th, td {
      text-align: left;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
    }
    th { color: var(--muted); font-weight: 500; }
    tr:hover { background: rgba(255,255,255,0.03); }
    #table-contracts td {
      max-width: 300px;
      word-wrap: break-word;
    }
    #table-contracts td:first-child {
      min-width: 200px;
    }
    #table-contracts td:nth-child(3) {
      max-width: 400px;
      font-size: 0.9em;
      color: var(--muted);
    }
    #table-contracts td .progress-pct { font-weight: 600; }
    #table-contracts .btn-take-task { font-size: 0.85rem; padding: 6px 12px; }
    .saved-client-row { display: flex; align-items: center; gap: 8px; padding: 4px 0; font-size: 0.9rem; }
    .saved-client-row button { padding: 4px 10px; font-size: 0.85rem; }
    .mono { font-family: ui-monospace, monospace; font-size: 0.85em; }
    .hash { max-width: 200px; overflow: hidden; text-overflow: ellipsis; }
    .msg { margin-top: 12px; padding: 10px; border-radius: 6px; font-size: 0.9rem; }
    .msg.info { background: rgba(92, 158, 173, 0.2); color: var(--accent); }
    .msg.err { background: rgba(229, 115, 115, 0.15); color: var(--error); }
    .msg.ok { background: rgba(124, 179, 66, 0.15); color: var(--success); }
    .node-links { margin-bottom: 16px; font-size: 0.9rem; color: var(--muted); }
    .node-links a { color: var(--accent); margin-right: 12px; }
    .loading { color: var(--muted); }
    .muted { color: var(--muted); }
    .progress-bar {
      height: 8px; background: var(--bg); border-radius: 4px; overflow: hidden; margin-top: 8px; max-width: 300px;
    }
    .progress-bar div { height: 100%; background: var(--accent); transition: width 0.2s; }
  </style>
</head>
<body>
  <h1>Distributed Compute - Узел оркестратора</h1>
  <div class="node-links">
    Узел: <span id="current-node">текущий</span>
    <a href="/dashboard">Обновить</a>
  </div>
  <div class="tabs">
    <button type="button" data-tab="overview" class="active">Обзор</button>
    <button type="button" data-tab="work">Работа</button>
    <button type="button" data-tab="contracts">Контракты</button>
    <button type="button" data-tab="tasks">Задачи</button>
    <button type="button" data-tab="chain">Блокчейн</button>
    <button type="button" data-tab="stats">Статистика</button>
    <button type="button" data-tab="profile">Профиль</button>
  </div>

  <div id="panel-overview" class="panel active">
    <div class="overview-grid">
      <div class="card"><div class="label">Состояние узла</div><div id="ov-status" class="value">-</div></div>
      <div class="card"><div class="label">Длина цепочки</div><div id="ov-chain" class="value">-</div></div>
      <div class="card"><div class="label">Вычислителей</div><div id="ov-clients" class="value">-</div></div>
      <div class="card"><div class="label">Транзакций в очереди</div><div id="ov-pending" class="value">-</div></div>
    </div>
    <div class="card" style="margin-bottom:20px;">
      <div class="label">Вычислители</div>
      <p class="muted" style="font-size:0.9em; margin-bottom:12px;">Контракты выполняются распределённо: вычислители получают задания, выполняют работу и сдают результат. Награды начисляются на баланс того вычислителя, с чьим API-ключом получена задача и сдана работа. Добавьте вычислителей (вход/регистрация или API-ключ) - прогресс и баланс сохраняются для каждого.</p>
      <div class="row" style="align-items:center; margin-bottom:12px;">
        <label>Текущий вычислитель:</label>
        <select id="select-client" style="margin-left:8px; min-width:220px; background:var(--bg); border:1px solid var(--border); color:var(--text); padding:6px 10px; border-radius:6px;">
          <option value="">- Ввести ключ вручную -</option>
        </select>
        <button type="button" class="primary" id="btn-sync-workers">Обновить данные</button>
      </div>
      <div id="saved-clients-list" class="card" style="margin-bottom:16px; max-height:200px; overflow:auto;"></div>
    <p class="label" style="margin-bottom:8px;">Добавить вычислителя</p>
    <p class="muted" style="font-size:0.85em; margin-bottom:8px;">Вход или регистрация создают вычислителя в списке; награды будут начисляться на его баланс. Либо добавьте уже имеющийся API-ключ.</p>
    <div id="auth-forms">
        <div class="row" style="margin-bottom:8px;">
          <input type="text" id="auth-login" placeholder="Логин" style="min-width:120px;">
          <input type="password" id="auth-password" placeholder="Пароль" style="min-width:120px;">
          <input type="text" id="auth-reg-nickname" placeholder="Никнейм (при регистрации)" style="min-width:140px;">
          <button type="button" class="primary" id="btn-auth-login">Войти</button>
          <button type="button" class="primary" id="btn-auth-register">Зарегистрироваться</button>
        </div>
        <div class="row">
          <span class="muted" style="margin-right:8px;">или вставить API-ключ:</span>
          <input type="text" id="input-api-key" placeholder="Вставьте api_key" style="min-width:180px;">
          <button type="button" class="primary" id="btn-add-client">Добавить</button>
        </div>
        <span id="auth-msg" class="msg" style="display:none;"></span>
      </div>
      <div id="auth-profile" style="display:none;">
        <p><strong>Вы вошли как</strong> <span id="profile-nickname">-</span> <span id="profile-login" class="muted" style="font-size:0.9em;"></span></p>
        <p>Баланс: <strong id="profile-balance">0</strong> токенов · Сдано работ: <strong id="profile-submissions">0</strong></p>
        <p class="muted" style="font-size:0.85em; margin-top:8px;">Баланс и сданные работы хранятся в блокчейне узла. Данные по всем вычислителям обновляются по кнопке «Обновить данные».</p>
        <button type="button" id="btn-auth-logout">Выйти</button>
      </div>
      <div class="row" style="margin-top:12px;">
        <button type="button" class="primary" id="btn-balance">Показать баланс текущего</button>
        <span id="balance-msg" class="msg" style="display:none;"></span>
      </div>
    </div>
  </div>

  <div id="panel-work" class="panel">
    <p class="label">Текущий вычислитель</p>
    <p class="muted" style="font-size:0.9em; margin-bottom:12px;">Выберите вычислителя на вкладке «Обзор» или вставьте его API-ключ. Награда за сданную работу начисляется на баланс этого вычислителя.</p>
    <div class="row">
      <input type="text" id="input-api-key-work" placeholder="API-ключ вычислителя">
    </div>
    <div class="row">
      <button type="button" class="primary" id="btn-get-task">Получить задачу</button>
      <span id="work-task-msg" class="msg" style="display:none;"></span>
    </div>
    <div id="work-task-spec" class="card" style="display:none; margin-bottom: 16px;">
      <div class="label">Текущая задача</div>
      <div class="mono" id="work-task-body"></div>
    </div>
      <div id="work-run-in-worker" class="card" style="display:none; margin-bottom: 16px;">
      <div class="label">Выполнить задачу в воркере</div>
      <p class="muted" style="font-size:0.85em; margin-bottom:8px;">Воркер запускается с API-ключом выбранного вычислителя (вкладка «Обзор») и <strong>только для контракта текущей задачи</strong> (см. блок «Текущая задача» выше). Награда начислится на этого вычислителя. Перед запуском нажмите «Использовать» для нужного вычислителя и при необходимости «Обновить данные».</p>
      <p class="muted" style="font-size:0.8em; margin-bottom:8px;">Если на баланс уже начислялись токены за другие контракты — вероятно, работал ещё один воркер (другой контейнер или запуск без выбора задачи). Остановите все контейнеры воркеров (<code>docker ps</code>, затем <code>docker stop &lt;id&gt;</code>), затем запустите только один раз с нужной задачей (сначала «Получить задачу» или «Взять задачу» по astro-002).</p>
      <div class="row" style="align-items:center; gap:12px; margin-bottom:12px;">
        <button type="button" class="primary" id="btn-start-worker">Запустить воркер автоматически</button>
        <span id="work-run-worker-msg" class="msg" style="display:none;"></span>
      </div>
      <div id="work-worker-status-hint" style="display:none; margin-top:8px;">
        <button type="button" class="primary" id="btn-check-balance-after-worker">Проверить баланс</button>
        <span id="work-worker-balance-result" class="msg" style="display:none; margin-left:8px;"></span>
        <p style="font-size:0.85em; color:var(--muted); margin:8px 0 0;">Через 10–60 сек воркер сдаст задачу. Вкладка «Задачи» - история сданных работ; «Обзор» → «Показать баланс» - начисленные токены.</p>
      </div>
      <p style="font-size:0.9em; color:var(--muted); margin:0 0 8px;">Или вручную в каталоге проекта:</p>
      <div class="row" style="align-items:center; gap:8px;">
        <code id="work-worker-cmd" class="mono" style="flex:1; background:var(--bg); padding:8px 12px; border-radius:6px; font-size:0.85rem; word-break:break-all;"></code>
        <button type="button" class="primary" id="btn-copy-worker-cmd">Копировать</button>
      </div>
      <p style="font-size:0.8em; color:var(--muted); margin:8px 0 0;">В Windows (CMD): <code>set CONTRACT_ID=<span id="work-worker-cid"></span> &amp;&amp; docker-compose run --rm client_worker_1</code></p>
    </div>
    <div class="row">
      <button type="button" class="primary" id="btn-run-work" disabled>Выполнить в браузере</button>
      <span id="work-progress" class="msg info" style="display:none;"></span>
      <p style="font-size:0.85em; color:var(--muted); margin-top:8px;">
        <strong>Примечание:</strong> Для астрофизических задач в браузере выполняется упрощённая версия (до 1000 единиц работы для скорости).
        Для получения награды требуется выполнить полный объём работы - используйте воркеры для полных вычислений.
        Простые задачи (sc-001, sc-002) можно выполнять полностью в браузере.
      </p>
    </div>
    <div id="work-result" class="msg" style="display:none;"></div>
  </div>

  <div id="panel-contracts" class="panel">
    <p class="muted" style="font-size:0.9em; margin-bottom:12px;">Контракты - типы заданий с наградой за сдачу. Вычислители берут задачу по контракту, выполняют требуемый объём работы и сдают результат. «Выполнено %» - доля от целевого объёма контракта; «Осталось» - сколько единиц работы ещё не выполнено; «Активных вычислителей» - кто недавно запрашивал задачу по этому контракту.</p>
    <p class="loading" id="contracts-load">Загрузка…</p>
    <table id="table-contracts" style="display:none;">
      <thead><tr><th>Название</th><th>Категория</th><th>Описание</th><th>Ед. на сдачу</th><th>Выполнено %</th><th>Активных вычислителей</th><th>Осталось (ед. работы)</th><th>Награда за сдачу</th><th>Действие</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="panel-tasks" class="panel">
    <p class="muted" style="font-size:0.9em; margin-bottom:12px;">Сданные работы (work_receipt) из блокчейна: вычислитель, контракт и количество единиц работы. Показаны последние 100 записей из последних 100 блоков (если сдачи по нужному контракту нет — она могла быть в более старом блоке).</p>
    <p class="loading" id="tasks-load">Загрузка…</p>
    <p id="tasks-empty" style="display:none; color: var(--muted);">Нет сданных работ в последних блоках.</p>
    <table id="table-tasks" style="display:none;">
      <thead><tr><th>Блок</th><th>Вычислитель</th><th>Контракт</th><th>Ед. работы</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="panel-chain" class="panel">
    <p class="loading" id="chain-load">Загрузка…</p>
    <table id="table-chain" style="display:none;">
      <thead><tr><th>Индекс</th><th>Хеш</th><th>Транзакций</th><th>Время</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="panel-stats" class="panel">
    <div class="overview-grid" style="margin-bottom: 20px;">
      <div class="card"><div class="label">Длина цепочки</div><div id="st-chain" class="value">-</div></div>
      <div class="card"><div class="label">Вычислителей (зарегистрировано)</div><div id="st-clients" class="value">-</div></div>
      <div class="card"><div class="label">Транзакций в очереди (pending)</div><div id="st-pending" class="value">-</div></div>
    </div>
    <p class="label">Запросы по путям</p>
    <pre id="st-requests" class="mono" style="background:var(--bg); padding:12px; border-radius:6px; overflow:auto; max-height:200px;"></pre>
    <p class="label" style="margin-top:12px;">Ошибки</p>
    <pre id="st-errors" class="mono" style="background:var(--bg); padding:12px; border-radius:6px; overflow:auto;"></pre>
  </div>

  <div id="panel-profile" class="panel">
    <p id="profile-login-required" class="msg info" style="display:none;">Войдите или выберите вычислителя с API-ключом на вкладке «Обзор», чтобы видеть профиль и вывод средств.</p>
    <div id="profile-content" style="display:none;">
      <div class="card" style="margin-bottom:20px;">
        <div class="label">Данные профиля</div>
        <div class="overview-grid" style="margin-top:12px;">
          <div class="card"><div class="label">Никнейм</div><div id="profile-nickname-full" class="value">-</div></div>
          <div class="card"><div class="label">Логин</div><div id="profile-login-full" class="value">-</div></div>
          <div class="card"><div class="label">ID вычислителя</div><div id="profile-client-id" class="value mono" style="font-size:0.9rem; word-break:break-all;">-</div></div>
          <div class="card"><div class="label">Баланс (токенов)</div><div id="profile-balance-full" class="value">-</div></div>
          <div class="card"><div class="label">Сдано работ</div><div id="profile-submissions-full" class="value">-</div></div>
        </div>
      </div>
      <div class="card" style="margin-bottom:20px;">
        <div class="label">Вывод средств (симуляция)</div>
        <p class="muted" style="font-size:0.9em; margin-bottom:12px;">Конвертация токенов в рубли и вывод на карту. Это демонстрационный режим: реальные платежи не выполняются.</p>
        <div class="row" style="align-items:center; gap:16px; margin-bottom:12px;">
          <span class="muted">Курс:</span>
          <strong id="profile-rate">1 токен = 10 ₽</strong>
        </div>
        <div class="row" style="align-items:center; gap:12px; margin-bottom:12px;">
          <label for="profile-withdraw-tokens">Сумма (токенов):</label>
          <input type="number" id="profile-withdraw-tokens" min="1" step="1" placeholder="0" style="min-width:120px;">
          <span class="muted">=</span>
          <span id="profile-withdraw-rub">0</span> <span>₽</span>
        </div>
        <div class="row" style="align-items:center; gap:12px; margin-bottom:12px;">
          <label for="profile-withdraw-card">Номер карты:</label>
          <input type="text" id="profile-withdraw-card" placeholder="0000 0000 0000 0000" maxlength="19" style="min-width:200px;">
        </div>
        <div class="row">
          <button type="button" class="primary" id="btn-profile-withdraw">Вывести на карту</button>
          <span id="profile-withdraw-msg" class="msg" style="display:none; margin-left:12px;"></span>
        </div>
      </div>
    </div>
  </div>

  <script>
    const base = window.location.origin;
    document.getElementById('current-node').textContent = base;

    function showPanel(id) {
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
      const panel = document.getElementById('panel-' + id);
      const btn = document.querySelector('.tabs button[data-tab="' + id + '"]');
      if (panel) panel.classList.add('active');
      if (btn) btn.classList.add('active');
      if (id === 'overview') loadOverview();
      if (id === 'work') { /* состояние задачи уже на панели */ }
      if (id === 'contracts') loadContracts();
      if (id === 'tasks') loadTasks();
      if (id === 'chain') loadChain();
      if (id === 'stats') loadStats();
      if (id === 'profile') loadProfile();
    }
    document.querySelectorAll('.tabs button').forEach(b => {
      b.addEventListener('click', () => showPanel(b.dataset.tab));
    });

    async function api(path) {
      const r = await fetch(base + path);
      if (!r.ok) throw new Error(r.status + ' ' + r.statusText);
      return r.json();
    }

    function loadOverview() {
      Promise.all([fetch(base + '/health').then(r => r.json()), api('/metrics')])
        .then(([health, m]) => {
          document.getElementById('ov-status').textContent = health.status === 'ok' ? 'OK' : health.status || '-';
          document.getElementById('ov-chain').textContent = m.chain_length ?? '-';
          document.getElementById('ov-clients').textContent = m.clients_count ?? '-';
          document.getElementById('ov-pending').textContent = m.pending_transactions ?? '-';
        })
        .catch(() => {
          document.getElementById('ov-status').textContent = 'Ошибка';
          document.getElementById('ov-chain').textContent = '-';
          document.getElementById('ov-clients').textContent = '-';
          document.getElementById('ov-pending').textContent = '-';
        });
    }

    let currentTask = null;

    const STORAGE_KEY_CLIENTS = 'dc_clients';
    function getSavedClients() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY_CLIENTS);
        return raw ? JSON.parse(raw) : [];
      } catch (e) { return []; }
    }
    function setSavedClients(list) {
      localStorage.setItem(STORAGE_KEY_CLIENTS, JSON.stringify(list));
    }
    function refreshClientSelect() {
      const list = getSavedClients();
      const sel = document.getElementById('select-client');
      const cur = sel.value;
      sel.innerHTML = '<option value="">- Ввести ключ вручную -</option>';
      list.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        const bal = c.balance != null ? c.balance : '-';
        const sub = c.submissions_count != null ? c.submissions_count : '-';
        opt.textContent = (c.label || 'Вычислитель') + ' · баланс: ' + bal + ' · сдано: ' + sub;
        sel.appendChild(opt);
      });
      if (cur && list.some(c => c.id === cur)) sel.value = cur;
    }
    async function syncWorkerData(c) {
      if (!c.apiKey) return c;
      try {
        const r = await fetch(base + '/me', { headers: { 'Authorization': 'Bearer ' + c.apiKey } });
        if (!r.ok) return c;
        const d = await r.json();
        return { ...c, balance: d.balance ?? 0, submissions_count: d.submissions_count ?? 0, client_id: d.client_id || c.client_id };
      } catch (e) { return c; }
    }
    document.getElementById('btn-sync-workers').onclick = async function() {
      const list = getSavedClients();
      if (!list.length) return;
      this.disabled = true;
      for (let i = 0; i < list.length; i++) {
        list[i] = await syncWorkerData(list[i]);
      }
      setSavedClients(list);
      refreshClientSelect();
      refreshSavedClientsList();
      this.disabled = false;
    };
    function refreshSavedClientsList() {
      const list = getSavedClients();
      const container = document.getElementById('saved-clients-list');
      container.innerHTML = '';
      if (!list.length) { container.innerHTML = '<span class="muted">Нет вычислителей. Войдите, зарегистрируйтесь или добавьте по API-ключу.</span>'; return; }
      list.forEach(c => {
        const row = document.createElement('div');
        row.className = 'saved-client-row';
        const bal = c.balance != null ? c.balance : '-';
        const sub = c.submissions_count != null ? c.submissions_count : '-';
        row.innerHTML = '<span><strong>' + (c.label || 'Вычислитель') + '</strong> - баланс: ' + bal + ' токенов, сдано работ: ' + sub + '</span>' +
          '<button type="button" class="primary" data-use="' + c.id + '">Использовать</button>' +
          '<button type="button" class="primary" data-sync-one="' + c.id + '">Обновить</button>' +
          '<button type="button" data-remove="' + c.id + '">Удалить</button>';
        row.querySelector('[data-use]').onclick = () => {
          document.getElementById('input-api-key').value = c.apiKey || '';
          document.getElementById('input-api-key-work').value = c.apiKey || '';
          document.getElementById('select-client').value = c.id;
        };
        row.querySelector('[data-sync-one]').onclick = async () => {
          const updated = await syncWorkerData(c);
          const newList = list.map(x => x.id === c.id ? updated : x);
          setSavedClients(newList);
          refreshClientSelect();
          refreshSavedClientsList();
        };
        row.querySelector('[data-remove]').onclick = () => {
          setSavedClients(list.filter(x => x.id !== c.id));
          refreshClientSelect();
          refreshSavedClientsList();
        };
        container.appendChild(row);
      });
    }
    document.getElementById('select-client').onchange = function() {
      const id = this.value;
      const list = getSavedClients();
      const c = list.find(x => x.id === id);
      if (c && c.apiKey) {
        document.getElementById('input-api-key').value = c.apiKey;
        document.getElementById('input-api-key-work').value = c.apiKey;
      }
      if (document.getElementById('panel-contracts').classList.contains('active')) loadContracts();
    };
    document.getElementById('btn-add-client').onclick = function() {
      const key = document.getElementById('input-api-key').value.trim();
      if (!key) { document.getElementById('auth-msg').className = 'msg err'; document.getElementById('auth-msg').textContent = 'Введите API-ключ.'; document.getElementById('auth-msg').style.display = 'block'; return; }
      const list = getSavedClients();
      const id = 'c' + Date.now();
      list.push({ id, label: 'Вычислитель ' + (list.length + 1), apiKey: key });
      setSavedClients(list);
      refreshClientSelect();
      refreshSavedClientsList();
      document.getElementById('select-client').value = id;
      document.getElementById('auth-msg').style.display = 'none';
    };
    refreshClientSelect();
    refreshSavedClientsList();

    const AUTH_API_KEY = 'dc_auth_api_key';
    const AUTH_NICKNAME = 'dc_auth_nickname';
    const AUTH_LOGIN = 'dc_auth_login';
    function showAuthProfile() {
      document.getElementById('auth-forms').style.display = 'none';
      document.getElementById('auth-profile').style.display = 'block';
    }
    function showAuthForms() {
      document.getElementById('auth-forms').style.display = 'block';
      document.getElementById('auth-profile').style.display = 'none';
      document.getElementById('auth-msg').style.display = 'none';
    }
    async function refreshProfileFromMe() {
      const key = localStorage.getItem(AUTH_API_KEY);
      if (!key) return;
      try {
        const r = await fetch(base + '/me', { headers: { 'Authorization': 'Bearer ' + key } });
        if (!r.ok) return;
        const d = await r.json();
        document.getElementById('profile-nickname').textContent = d.nickname || d.login || d.client_id?.slice(0, 8) + '…';
        document.getElementById('profile-login').textContent = d.login ? '(' + d.login + ')' : '';
        document.getElementById('profile-balance').textContent = d.balance ?? 0;
        document.getElementById('profile-submissions').textContent = d.submissions_count ?? 0;
      } catch (e) {}
    }
    async function applyAuthSession(apiKey, nickname, login) {
      localStorage.setItem(AUTH_API_KEY, apiKey);
      if (nickname) localStorage.setItem(AUTH_NICKNAME, nickname);
      if (login) localStorage.setItem(AUTH_LOGIN, login);
      document.getElementById('input-api-key').value = apiKey;
      document.getElementById('input-api-key-work').value = apiKey;
      const list = getSavedClients();
      const existing = list.find(c => c.apiKey === apiKey);
      if (!existing) {
        const newItem = { id: 'auth-' + Date.now(), label: nickname || login || 'Вычислитель', apiKey: apiKey };
        const withStats = await syncWorkerData(newItem);
        list.push(withStats);
        setSavedClients(list);
        refreshClientSelect();
        refreshSavedClientsList();
      }
      showAuthProfile();
      refreshProfileFromMe();
    }
    document.getElementById('btn-auth-login').onclick = async function() {
      const login = document.getElementById('auth-login').value.trim();
      const password = document.getElementById('auth-password').value;
      const msg = document.getElementById('auth-msg');
      msg.style.display = 'none';
      if (!login || !password) { msg.className = 'msg err'; msg.textContent = 'Введите логин и пароль.'; msg.style.display = 'block'; return; }
      try {
        const r = await fetch(base + '/auth/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ login: login, password: password }) });
        const d = await r.json();
        if (!r.ok) { msg.className = 'msg err'; msg.textContent = d.error || r.status; msg.style.display = 'block'; return; }
        await applyAuthSession(d.api_key, d.nickname, d.login);
      } catch (e) { msg.className = 'msg err'; msg.textContent = 'Ошибка: ' + e.message; msg.style.display = 'block'; }
    };
    document.getElementById('btn-auth-register').onclick = async function() {
      const login = document.getElementById('auth-login').value.trim();
      const password = document.getElementById('auth-password').value;
      const nickname = document.getElementById('auth-reg-nickname').value.trim();
      const msg = document.getElementById('auth-msg');
      msg.style.display = 'none';
      if (!login || !password) { msg.className = 'msg err'; msg.textContent = 'Введите логин и пароль (пароль не менее 6 символов).'; msg.style.display = 'block'; return; }
      try {
        const r = await fetch(base + '/auth/register', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ login: login, password: password, nickname: nickname || login }) });
        const d = await r.json();
        if (!r.ok) { msg.className = 'msg err'; msg.textContent = d.error || r.status; msg.style.display = 'block'; return; }
        await applyAuthSession(d.api_key, d.nickname, d.login);
      } catch (e) { msg.className = 'msg err'; msg.textContent = 'Ошибка: ' + e.message; msg.style.display = 'block'; }
    };
    document.getElementById('btn-auth-logout').onclick = function() {
      localStorage.removeItem(AUTH_API_KEY);
      localStorage.removeItem(AUTH_NICKNAME);
      localStorage.removeItem(AUTH_LOGIN);
      document.getElementById('input-api-key').value = '';
      document.getElementById('input-api-key-work').value = '';
      showAuthForms();
      if (document.getElementById('panel-contracts').classList.contains('active')) loadContracts();
    };
    if (localStorage.getItem(AUTH_API_KEY)) {
      const key = localStorage.getItem(AUTH_API_KEY);
      document.getElementById('input-api-key').value = key;
      document.getElementById('input-api-key-work').value = key;
      showAuthProfile();
      refreshProfileFromMe();
    } else {
      showAuthForms();
    }

    async function sha256Hex(str) {
      const buf = new TextEncoder().encode(str);
      const hash = await crypto.subtle.digest('SHA-256', buf);
      return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function runPoW(clientId, contractId, workUnitsRequired, difficulty, onProgress) {
      const targetPrefix = '0'.repeat(difficulty);
      let workUnitsDone = 0;
      let resultData = null, solutionNonce = null;
      while (workUnitsDone < workUnitsRequired || !solutionNonce) {
        workUnitsDone += 1;
        const nonce = String(workUnitsDone);
        const text = clientId + '-' + contractId + '-' + nonce;
        const hashHex = await sha256Hex(text);
        if (hashHex.startsWith(targetPrefix)) {
          resultData = hashHex;
          solutionNonce = nonce;
        }
        if (workUnitsDone % 50 === 0) onProgress(workUnitsDone);
      }
      return { work_units_done: workUnitsDone, result_data: resultData, nonce: solutionNonce };
    }

    // Упрощённые версии астрофизических вычислений для браузера (для демонстрации)
    async function runAstrophysicsComputation(clientId, contractId, workUnitsRequired, computationType, onProgress) {
      // Для браузера используем упрощённые вычисления (меньше итераций для скорости)
      const browserWorkUnits = Math.min(workUnitsRequired, 1000); // Ограничиваем для браузера
      let resultData = null;
      let seed = 0;
      
      // Генерируем seed детерминированно
      for (let i = 0; i < clientId.length; i++) {
        seed = ((seed << 5) - seed + clientId.charCodeAt(i)) & 0xffffffff;
      }
      for (let i = 0; i < contractId.length; i++) {
        seed = ((seed << 5) - seed + contractId.charCodeAt(i)) & 0xffffffff;
      }
      seed = Math.abs(seed) % (2**32);
      
      // Простой генератор случайных чисел (LCG) для детерминированности
      let rng = seed;
      function random() {
        rng = (rng * 1664525 + 1013904223) % (2**32);
        return (rng >>> 0) / (2**32);
      }
      
      // Упрощённые вычисления в зависимости от типа
      if (computationType === 'cosmological') {
        // Упрощённая N-body задача (10 частиц вместо 100)
        const n = 10;
        const particles = [];
        for (let i = 0; i < n; i++) {
          particles.push({ x: random() * 2 - 1, y: random() * 2 - 1, z: random() * 2 - 1, mass: random() + 0.5 });
        }
        for (let step = 0; step < browserWorkUnits; step++) {
          for (let i = 0; i < n; i++) {
            let fx = 0, fy = 0, fz = 0;
            for (let j = 0; j < n; j++) {
              if (i === j) continue;
              const dx = particles[j].x - particles[i].x;
              const dy = particles[j].y - particles[i].y;
              const dz = particles[j].z - particles[i].z;
              const distSq = dx*dx + dy*dy + dz*dz + 0.01;
              const dist = Math.sqrt(distSq);
              const force = particles[i].mass * particles[j].mass / (distSq * dist);
              fx += force * dx;
              fy += force * dy;
              fz += force * dz;
            }
            particles[i].x += fx * 0.01 / particles[i].mass;
            particles[i].y += fy * 0.01 / particles[i].mass;
            particles[i].z += fz * 0.01 / particles[i].mass;
          }
          if (step % 10 === 0) onProgress(step);
        }
        const finalState = `${particles[0].x.toFixed(6)}${particles[0].y.toFixed(6)}`;
        resultData = await sha256Hex(finalState);
      } else if (computationType === 'supernova') {
        // Упрощённое моделирование сверхновой
        let T = 1e9, P = 1e15, rho = 1e6;
        for (let step = 0; step < browserWorkUnits; step++) {
          const dT = -0.1 * T * rho / (1.0 + T/1e8);
          const dP = -0.05 * P * T / 1e9;
          const drho = -0.02 * rho * Math.sqrt(T/1e9);
          T += dT * 0.001;
          P += dP * 0.001;
          rho += drho * 0.001;
          T = Math.max(T, 1e7);
          P = Math.max(P, 1e10);
          rho = Math.max(rho, 1e3);
          if (step % 10 === 0) onProgress(step);
        }
        const finalState = `${T.toExponential(6)}${P.toExponential(6)}${rho.toExponential(6)}`;
        resultData = await sha256Hex(finalState);
      } else if (computationType === 'mhd') {
        // Упрощённая МГД (сетка 5x5x5 вместо 20x20x20)
        const size = 5;
        const Bx = [], By = [], Bz = [];
        for (let i = 0; i < size; i++) {
          Bx[i] = []; By[i] = []; Bz[i] = [];
          for (let j = 0; j < size; j++) {
            Bx[i][j] = []; By[i][j] = []; Bz[i][j] = [];
            for (let k = 0; k < size; k++) {
              Bx[i][j][k] = random() * 2 - 1;
              By[i][j][k] = random() * 2 - 1;
              Bz[i][j][k] = random() * 2 - 1;
            }
          }
        }
        for (let step = 0; step < browserWorkUnits; step++) {
          for (let i = 1; i < size-1; i++) {
            for (let j = 1; j < size-1; j++) {
              for (let k = 1; k < size-1; k++) {
                const dBx = (Bx[i+1][j][k] - Bx[i-1][j][k]) / 2.0 * 0.1;
                const dBy = (By[i][j+1][k] - By[i][j-1][k]) / 2.0 * 0.1;
                const dBz = (Bz[i][j][k+1] - Bz[i][j][k-1]) / 2.0 * 0.1;
                Bx[i][j][k] += dBx * 0.001;
                By[i][j][k] += dBy * 0.001;
                Bz[i][j][k] += dBz * 0.001;
              }
            }
          }
          if (step % 10 === 0) onProgress(step);
        }
        const finalState = `${Bx[2][2][2].toFixed(6)}${By[2][2][2].toFixed(6)}${Bz[2][2][2].toFixed(6)}`;
        resultData = await sha256Hex(finalState);
      } else if (computationType === 'radiative') {
        // Упрощённый радиационный перенос
        const nAngles = 5, nFreq = 10, nPoints = 20;
        const I = [];
        for (let a = 0; a < nAngles; a++) {
          I[a] = [];
          for (let f = 0; f < nFreq; f++) {
            I[a][f] = [];
            for (let p = 0; p < nPoints; p++) {
              I[a][f][p] = random();
            }
          }
        }
        for (let step = 0; step < browserWorkUnits; step++) {
          for (let a = 0; a < nAngles; a++) {
            const angle = a * Math.PI / nAngles;
            const cosAngle = Math.cos(angle);
            for (let f = 0; f < nFreq; f++) {
              const freq = f * 0.1;
              for (let p = 1; p < nPoints; p++) {
                const dI = -I[a][f][p] * (1.0 + freq);
                const source = 0.1 * Math.exp(-freq) * (1.0 + cosAngle);
                I[a][f][p] += (dI + source) * 0.01;
                I[a][f][p] = Math.max(0, I[a][f][p]);
              }
            }
          }
          if (step % 10 === 0) onProgress(step);
        }
        let total = 0;
        for (let a = 0; a < nAngles; a++) {
          for (let f = 0; f < nFreq; f++) {
            for (let p = 0; p < nPoints; p++) {
              total += I[a][f][p];
            }
          }
        }
        const finalState = total.toExponential(6);
        resultData = await sha256Hex(finalState);
      } else if (computationType === 'gravitational_waves') {
        // Упрощённые гравитационные волны (сетка 10x10 вместо 30x30)
        const size = 10;
        let hPlus = [], hCross = [];
        for (let i = 0; i < size; i++) {
          hPlus[i] = []; hCross[i] = [];
          for (let j = 0; j < size; j++) {
            hPlus[i][j] = (random() - 0.5) * 0.02;
            hCross[i][j] = (random() - 0.5) * 0.02;
          }
        }
        const dt = 0.001, dx = 0.1;
        for (let step = 0; step < browserWorkUnits; step++) {
          const hPlusNew = [], hCrossNew = [];
          for (let i = 0; i < size; i++) {
            hPlusNew[i] = []; hCrossNew[i] = [];
            for (let j = 0; j < size; j++) {
              if (i > 0 && i < size-1 && j > 0 && j < size-1) {
                const d2h_dx2_p = (hPlus[i+1][j] - 2*hPlus[i][j] + hPlus[i-1][j]) / (dx*dx);
                const d2h_dy2_p = (hPlus[i][j+1] - 2*hPlus[i][j] + hPlus[i][j-1]) / (dx*dx);
                const d2h_dx2_c = (hCross[i+1][j] - 2*hCross[i][j] + hCross[i-1][j]) / (dx*dx);
                const d2h_dy2_c = (hCross[i][j+1] - 2*hCross[i][j] + hCross[i][j-1]) / (dx*dx);
                hPlusNew[i][j] = hPlus[i][j] + dt * (d2h_dx2_p + d2h_dy2_p);
                hCrossNew[i][j] = hCross[i][j] + dt * (d2h_dx2_c + d2h_dy2_c);
              } else {
                hPlusNew[i][j] = hPlus[i][j];
                hCrossNew[i][j] = hCross[i][j];
              }
            }
          }
          hPlus = hPlusNew;
          hCross = hCrossNew;
          if (step % 10 === 0) onProgress(step);
        }
        const amplitude = Math.sqrt(hPlus[5][5]**2 + hCross[5][5]**2);
        const finalState = amplitude.toExponential(6);
        resultData = await sha256Hex(finalState);
      } else {
        // Fallback: используем простой PoW
        return await runPoW(clientId, contractId, Math.min(workUnitsRequired, 1000), 3, onProgress);
      }
      
      return { 
        work_units_done: browserWorkUnits, 
        result_data: resultData, 
        nonce: String(seed) 
      };
    }

    function getApiKey() {
      const sel = document.getElementById('select-client').value;
      if (sel) {
        const c = getSavedClients().find(x => x.id === sel);
        if (c && c.apiKey) return c.apiKey;
      }
      const k1 = document.getElementById('input-api-key').value.trim();
      const k2 = document.getElementById('input-api-key-work').value.trim();
      return k2 || k1;
    }

    function setCurrentTask(task) {
      currentTask = task;
      const specEl = document.getElementById('work-task-spec');
      const bodyEl = document.getElementById('work-task-body');
      const runBtn = document.getElementById('btn-run-work');
      const msg = document.getElementById('work-task-msg');
      specEl.style.display = 'block';
      const taskName = task.task_name || task.contract_id || '';
      const taskDesc = task.task_description || '';
      const taskCategory = task.task_category || '';
      let html = '';
      if (taskName) html += '<strong>Название:</strong> ' + taskName + '<br>';
      if (taskCategory) html += '<strong>Категория:</strong> ' + taskCategory + '<br>';
      if (taskDesc) html += '<strong>Описание:</strong> ' + taskDesc + '<br>';
      html += '<strong>Contract ID:</strong> ' + (task.contract_id || '') + '<br>';
      html += '<strong>Work units required:</strong> ' + (task.work_units_required ?? '') + '<br>';
      html += '<strong>Difficulty:</strong> ' + (task.difficulty ?? '') + '<br>';
      if (task.computation_type) html += '<strong>Тип вычислений:</strong> ' + task.computation_type;
      bodyEl.innerHTML = html;
      runBtn.disabled = false;
      msg.className = 'msg ok';
      msg.textContent = 'Задача: ' + (taskName || task.contract_id || '') + ', единиц работы: ' + (task.work_units_required ?? '');
      msg.style.display = 'block';
      // Блок «Выполнить в воркере»: команда с CONTRACT_ID
      const cid = task.contract_id || '';
      const workerBlock = document.getElementById('work-run-in-worker');
      const cmdEl = document.getElementById('work-worker-cmd');
      const cidEl = document.getElementById('work-worker-cid');
      if (cid && workerBlock && cmdEl && cidEl) {
        workerBlock.style.display = 'block';
        const cmd = 'CONTRACT_ID=' + cid + ' docker-compose run --rm client_worker_1';
        cmdEl.textContent = cmd;
        cidEl.textContent = cid;
      } else if (workerBlock) {
        workerBlock.style.display = 'none';
      }
    }

    document.getElementById('btn-copy-worker-cmd').onclick = function() {
      const cmdEl = document.getElementById('work-worker-cmd');
      if (!cmdEl || !cmdEl.textContent) return;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(cmdEl.textContent).then(() => { this.textContent = 'Скопировано'; setTimeout(() => { this.textContent = 'Копировать'; }, 1500); }).catch(() => {});
      } else {
        const sel = window.getSelection();
        const r = document.createRange();
        r.selectNodeContents(cmdEl);
        sel.removeAllRanges();
        sel.addRange(r);
        try { document.execCommand('copy'); this.textContent = 'Скопировано'; setTimeout(() => { this.textContent = 'Копировать'; }, 1500); } catch (e) {}
        sel.removeAllRanges();
      }
    };

    document.getElementById('btn-start-worker').onclick = async function() {
      const key = getApiKey();
      const msgEl = document.getElementById('work-run-worker-msg');
      msgEl.style.display = 'none';
      if (!key) { msgEl.className = 'msg err'; msgEl.textContent = 'Выберите вычислителя или введите API-ключ.'; msgEl.style.display = 'block'; return; }
      if (!currentTask || !currentTask.contract_id) { msgEl.className = 'msg err'; msgEl.textContent = 'Сначала получите или выберите задачу.'; msgEl.style.display = 'block'; return; }
      const sel = document.getElementById('select-client').value;
      const list = getSavedClients();
      const selectedClient = list.find(function(c) { return c.id === sel; });
      const body = { contract_id: currentTask.contract_id };
      if (selectedClient && selectedClient.client_id) body.client_id = selectedClient.client_id;
      this.disabled = true;
      try {
        const r = await fetch(base + '/run_worker', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + key },
          body: JSON.stringify(body)
        });
        const data = await r.json().catch(() => ({}));
        msgEl.style.display = 'block';
        if (r.status === 202) {
          msgEl.className = 'msg ok';
          var who = (selectedClient && selectedClient.label) ? selectedClient.label : 'вычислитель';
          if (data.client_id) who += ' (ID: ' + (data.client_id.length > 8 ? data.client_id.slice(0, 8) + '…' : data.client_id) + ')';
          msgEl.textContent = (data.message || 'Воркер запущен. ') + ' Награда будет начислена на: ' + who + '.';
          document.getElementById('work-worker-status-hint').style.display = 'block';
          document.getElementById('work-worker-balance-result').style.display = 'none';
        } else {
          document.getElementById('work-worker-status-hint').style.display = 'none';
          msgEl.className = 'msg err';
          var errText = data.error || '';
          if (data.detail) errText += (errText ? ': ' : '') + data.detail;
          if (!errText) errText = r.status + ' ' + r.statusText;
          msgEl.textContent = errText;
          if (data.detail && (String(data.detail).toLowerCase().indexOf('image') !== -1 || String(data.detail).indexOf('not found') !== -1)) {
            msgEl.textContent += ' Подсказка: в папке проекта выполните docker-compose build, затем повторите.';
          } else if (data.detail && (String(data.detail).toLowerCase().indexOf('docker') !== -1 || String(data.detail).toLowerCase().indexOf('socket') !== -1)) {
            msgEl.textContent += ' Подсказка: убедитесь, что Docker Desktop запущен и контейнеры подняты через start.bat (docker-compose).';
          }
        }
      } catch (e) {
        msgEl.className = 'msg err';
        msgEl.textContent = 'Ошибка: ' + e.message;
        msgEl.style.display = 'block';
      }
      this.disabled = false;
    };

    document.getElementById('btn-check-balance-after-worker').onclick = async function() {
      const key = getApiKey();
      const resultEl = document.getElementById('work-worker-balance-result');
      resultEl.style.display = 'none';
      if (!key) { resultEl.className = 'msg err'; resultEl.textContent = 'Выберите вычислителя или введите API-ключ.'; resultEl.style.display = 'block'; return; }
      try {
        const meRes = await fetch(base + '/me', { headers: { 'Authorization': 'Bearer ' + key } });
        const meData = await meRes.json();
        if (!meRes.ok) throw new Error(meData.error || 'Неверный ключ');
        const balRes = await fetch(base + '/get_balance/' + encodeURIComponent(meData.client_id), { headers: { 'Authorization': 'Bearer ' + key } });
        const balData = await balRes.json();
        if (!balRes.ok) throw new Error(balData.error || balRes.status);
        resultEl.className = 'msg ok';
        const bal = balData.balance ?? 0;
        resultEl.textContent = 'Баланс: ' + bal + ' токенов.';
        if (bal === 0) resultEl.textContent += ' Если воркер уже сдал задачу - подождите 30–60 сек и нажмите снова. Диагностика: docker logs orchestrator_node_1';
        resultEl.style.display = 'block';
      } catch (e) {
        resultEl.className = 'msg err';
        resultEl.textContent = 'Ошибка: ' + e.message;
        resultEl.style.display = 'block';
      }
    };

    document.getElementById('btn-get-task').onclick = async () => {
      const key = getApiKey();
      const msg = document.getElementById('work-task-msg');
      msg.style.display = 'none';
      if (!key) { msg.className = 'msg err'; msg.textContent = 'Введите API-ключ (вкладка Обзор или выберите вычислителя).'; msg.style.display = 'block'; return; }
      try {
        const r = await fetch(base + '/get_task', { headers: { 'Authorization': 'Bearer ' + key } });
        const task = await r.json();
        if (!r.ok) throw new Error(task.error || r.status);
        setCurrentTask(task);
      } catch (e) {
        msg.className = 'msg err';
        msg.textContent = 'Ошибка: ' + e.message;
        msg.style.display = 'block';
      }
    };

    document.getElementById('btn-run-work').onclick = async () => {
      const key = getApiKey();
      if (!key) { document.getElementById('work-result').className = 'msg err'; document.getElementById('work-result').textContent = 'Введите API-ключ.'; document.getElementById('work-result').style.display = 'block'; return; }
      if (!currentTask) { document.getElementById('work-result').className = 'msg err'; document.getElementById('work-result').textContent = 'Сначала нажмите «Получить задачу».'; document.getElementById('work-result').style.display = 'block'; return; }
      const runBtn = document.getElementById('btn-run-work');
      const progressEl = document.getElementById('work-progress');
      const resultEl = document.getElementById('work-result');
      runBtn.disabled = true;
      progressEl.style.display = 'block';
      progressEl.textContent = 'Получение client_id…';
      resultEl.style.display = 'none';
      try {
        const meRes = await fetch(base + '/me', { headers: { 'Authorization': 'Bearer ' + key } });
        const meData = await meRes.json();
        if (!meRes.ok) throw new Error(meData.error || 'Неверный API-ключ');
        const clientId = meData.client_id;
        const targetWork = parseInt(currentTask.work_units_required, 10) || 0;
        const difficulty = parseInt(currentTask.difficulty, 10) || 0;
        const computationType = currentTask.computation_type || 'simple_pow';
        
        // Выбираем тип вычислений
        let result;
        if (computationType === 'simple_pow') {
          progressEl.textContent = 'Вычисление PoW (0 из ' + targetWork + ')…';
          result = await runPoW(clientId, currentTask.contract_id, targetWork, difficulty, (n) => {
            progressEl.textContent = 'Вычисление PoW (' + n + ' из ' + targetWork + ')…';
          });
        } else {
          // Астрофизические задачи: используем упрощённые вычисления для браузера
          const taskName = currentTask.task_name || currentTask.contract_id || '';
          const browserWorkUnits = Math.min(targetWork, 1000); // Ограничиваем для браузера
          progressEl.textContent = 'Вычисление: ' + taskName + ' (0 из ' + browserWorkUnits + ')…';
          result = await runAstrophysicsComputation(clientId, currentTask.contract_id, browserWorkUnits, computationType, (n) => {
            progressEl.textContent = 'Вычисление: ' + taskName + ' (' + n + ' из ' + browserWorkUnits + ')…';
          });
          // Отправляем реальный объём выполненной работы (для браузера это упрощённая версия)
          // Примечание: для полных вычислений используйте воркер
        }
        
        // Проверяем, достаточно ли работы выполнено для астрофизических задач
        if (computationType !== 'simple_pow' && result.work_units_done < targetWork) {
          // Для астрофизических задач в браузере выполняется упрощённая версия
          progressEl.style.display = 'none';
          runBtn.disabled = false;
          resultEl.className = 'msg info';
          resultEl.textContent = 'Выполнено ' + result.work_units_done + ' из ' + targetWork + ' единиц работы (упрощённая версия для браузера). ' +
            'Для полных вычислений используйте воркер. Результат не отправлен (недостаточно работы для получения награды).';
          resultEl.style.display = 'block';
          return;
        }
        
        progressEl.textContent = 'Отправка результата…';
        const subRes = await fetch(base + '/submit_work', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + key },
          body: JSON.stringify({
            client_id: clientId,
            contract_id: currentTask.contract_id,
            work_units_done: result.work_units_done,
            result_data: result.result_data,
            nonce: result.nonce
          })
        });
        const subData = await subRes.json();
        progressEl.style.display = 'none';
        runBtn.disabled = false;
        if (!subRes.ok) throw new Error(subData.error || subRes.status);
        resultEl.className = 'msg ok';
        resultEl.textContent = 'Работа принята. Начислено: ' + (subData.reward_issued ?? '') + ' токенов.';
        resultEl.style.display = 'block';
      } catch (e) {
        progressEl.style.display = 'none';
        runBtn.disabled = false;
        resultEl.className = 'msg err';
        resultEl.textContent = 'Ошибка: ' + e.message;
        resultEl.style.display = 'block';
      }
    };

    document.getElementById('btn-balance').onclick = async () => {
      const key = document.getElementById('input-api-key').value.trim();
      const msg = document.getElementById('balance-msg');
      msg.style.display = 'none';
      if (!key) { msg.className = 'msg err'; msg.textContent = 'Введите api_key'; msg.style.display = 'block'; return; }
      try {
        const meRes = await fetch(base + '/me', { headers: { 'Authorization': 'Bearer ' + key } });
        const meData = await meRes.json();
        if (!meRes.ok) throw new Error(meData.error || meRes.status);
        const clientId = meData.client_id;
        const balRes = await fetch(base + '/get_balance/' + encodeURIComponent(clientId), {
          headers: { 'Authorization': 'Bearer ' + key }
        });
        const balData = await balRes.json();
        if (!balRes.ok) throw new Error(balData.error || balRes.status);
        msg.className = 'msg ok';
        msg.textContent = 'Баланс: ' + (balData.balance ?? 0);
        msg.style.display = 'block';
      } catch (e) {
        msg.className = 'msg err';
        msg.textContent = 'Ошибка: ' + e.message;
        msg.style.display = 'block';
      }
    };

    function loadContracts() {
      const load = document.getElementById('contracts-load');
      const table = document.getElementById('table-contracts');
      api('/contracts')
        .then(list => {
          load.style.display = 'none';
          const tbody = table.querySelector('tbody');
          tbody.innerHTML = '';
          const key = getApiKey();
          (list || []).forEach(c => {
            const tr = document.createElement('tr');
            const category = c.task_category || '';
            const name = c.task_name || c.contract_id || '';
            const desc = c.task_description || '';
            const pct = c.completion_pct != null ? c.completion_pct : '-';
            const active = c.active_workers != null ? c.active_workers : '-';
            const freeVol = (c.remaining_volume != null ? c.remaining_volume : c.free_volume) ?? (c.work_units_required ?? '-');
            const reward = c.reward_per_task != null ? c.reward_per_task : (c.reward ?? '-');
            const takeBtn = key
              ? '<button type="button" class="primary btn-take-task" data-contract-id="' + (c.contract_id || '') + '">Взять задачу</button>'
              : '<span class="muted">Войдите</span>';
            tr.innerHTML =
              '<td><strong>' + (name || '') + '</strong><br><small style="color:#888;">' + (c.contract_id || '') + '</small></td>' +
              '<td>' + (category || '-') + '</td>' +
              '<td>' + (desc || '-') + '</td>' +
              '<td>' + (c.work_units_required ?? '-') + '</td>' +
              '<td><span class="progress-pct">' + pct + '%</span></td>' +
              '<td>' + active + '</td>' +
              '<td>' + freeVol + '</td>' +
              '<td><strong>' + reward + '</strong></td>' +
              '<td>' + takeBtn + '</td>';
            tbody.appendChild(tr);
            const btn = tr.querySelector('.btn-take-task');
            if (btn) {
              btn.onclick = async () => {
                const apiKey = getApiKey();
                if (!apiKey) { alert('Выберите вычислителя или введите API-ключ.'); return; }
                try {
                  const r = await fetch(base + '/get_task?contract_id=' + encodeURIComponent(c.contract_id), { headers: { 'Authorization': 'Bearer ' + apiKey } });
                  const task = await r.json();
                  if (!r.ok) throw new Error(task.error || r.status);
                  setCurrentTask(task);
                  showPanel('work');
                } catch (e) {
                  alert('Ошибка: ' + e.message);
                }
              };
            }
          });
          table.style.display = (list && list.length) ? 'table' : 'none';
        })
        .catch(() => { load.textContent = 'Ошибка загрузки'; });
    }

    function loadTasks() {
      const load = document.getElementById('tasks-load');
      const empty = document.getElementById('tasks-empty');
      const table = document.getElementById('table-tasks');
      api('/chain')
        .then(chain => {
          load.style.display = 'none';
          const rows = [];
          (chain || []).slice(-100).forEach(block => {
            (block.transactions || []).forEach(tx => {
              if (tx.type === 'work_receipt')
                rows.push({ block: block.index, client: (tx.client_id || '').slice(0, 8) + '…', contract: tx.contract_id || '', units: tx.work_units ?? '' });
            });
          });
          rows.reverse();
          const tbody = table.querySelector('tbody');
          tbody.innerHTML = '';
          rows.slice(0, 100).forEach(r => {
            const tr = document.createElement('tr');
            tr.innerHTML = '<td>' + r.block + '</td><td class="mono">' + r.client + '</td><td>' + r.contract + '</td><td>' + r.units + '</td>';
            tbody.appendChild(tr);
          });
          table.style.display = rows.length ? 'table' : 'none';
          empty.style.display = rows.length ? 'none' : 'block';
        })
        .catch(() => { load.textContent = 'Ошибка загрузки'; });
    }

    function loadChain() {
      const load = document.getElementById('chain-load');
      const table = document.getElementById('table-chain');
      api('/chain')
        .then(chain => {
          load.style.display = 'none';
          const list = (chain || []).slice(-30).reverse();
          const tbody = table.querySelector('tbody');
          tbody.innerHTML = '';
          list.forEach(b => {
            const tr = document.createElement('tr');
            const ts = b.timestamp ? new Date(b.timestamp * 1000).toLocaleString() : '-';
            tr.innerHTML = '<td>' + b.index + '</td><td class="mono hash" title="' + (b.hash || '') + '">' + (b.hash || '') + '</td><td>' + (b.transactions && b.transactions.length) + '</td><td>' + ts + '</td>';
            tbody.appendChild(tr);
          });
          table.style.display = 'table';
        })
        .catch(() => { load.textContent = 'Ошибка загрузки'; });
    }

    function loadStats() {
      api('/metrics')
        .then(m => {
          document.getElementById('st-chain').textContent = m.chain_length ?? '-';
          document.getElementById('st-clients').textContent = m.clients_count ?? '-';
          document.getElementById('st-pending').textContent = m.pending_transactions ?? '-';
          document.getElementById('st-requests').textContent = JSON.stringify(m.request_counts || {}, null, 2);
          document.getElementById('st-errors').textContent = JSON.stringify(m.error_counts || {}, null, 2);
        })
        .catch(() => {
          document.getElementById('st-requests').textContent = 'Ошибка загрузки';
        });
    }

    const PROFILE_TOKEN_RATE_RUB = 10;
    let profileData = null;

    function loadProfile() {
      const key = getApiKey();
      const loginRequired = document.getElementById('profile-login-required');
      const content = document.getElementById('profile-content');
      const msg = document.getElementById('profile-withdraw-msg');
      msg.style.display = 'none';
      if (!key) {
        loginRequired.style.display = 'block';
        content.style.display = 'none';
        return;
      }
      loginRequired.style.display = 'none';
      content.style.display = 'block';
      fetch(base + '/me', { headers: { 'Authorization': 'Bearer ' + key } })
        .then(r => {
          if (!r.ok) throw new Error('Неверный API-ключ');
          return r.json();
        })
        .then(d => {
          profileData = d;
          document.getElementById('profile-nickname-full').textContent = d.nickname || d.login || d.client_id?.slice(0, 8) + '…' || '-';
          document.getElementById('profile-login-full').textContent = d.login || '-';
          document.getElementById('profile-client-id').textContent = d.client_id || '-';
          document.getElementById('profile-client-id').title = d.client_id || '';
          document.getElementById('profile-balance-full').textContent = d.balance ?? 0;
          document.getElementById('profile-submissions-full').textContent = d.submissions_count ?? 0;
          updateProfileWithdrawRub();
        })
        .catch(() => {
          loginRequired.style.display = 'block';
          content.style.display = 'none';
        });
    }

    function updateProfileWithdrawRub() {
      const el = document.getElementById('profile-withdraw-tokens');
      const rubEl = document.getElementById('profile-withdraw-rub');
      if (!el || !rubEl) return;
      const tokens = parseInt(el.value, 10) || 0;
      rubEl.textContent = (tokens * PROFILE_TOKEN_RATE_RUB).toLocaleString('ru-RU');
    }

    document.getElementById('profile-withdraw-tokens').addEventListener('input', updateProfileWithdrawRub);

    document.getElementById('btn-profile-withdraw').onclick = function() {
      const key = getApiKey();
      const msgEl = document.getElementById('profile-withdraw-msg');
      msgEl.style.display = 'none';
      if (!key || !profileData) {
        msgEl.className = 'msg err';
        msgEl.textContent = 'Загрузите профиль (откройте вкладку ещё раз).';
        msgEl.style.display = 'block';
        return;
      }
      const tokens = parseInt(document.getElementById('profile-withdraw-tokens').value, 10);
      const card = (document.getElementById('profile-withdraw-card').value || '').replace(/\s/g, '');
      if (!tokens || tokens < 1) {
        msgEl.className = 'msg err';
        msgEl.textContent = 'Укажите сумму в токенах (не менее 1).';
        msgEl.style.display = 'block';
        return;
      }
      if (tokens > (profileData.balance || 0)) {
        msgEl.className = 'msg err';
        msgEl.textContent = 'Недостаточно токенов на балансе.';
        msgEl.style.display = 'block';
        return;
      }
      if (card.length < 12) {
        msgEl.className = 'msg err';
        msgEl.textContent = 'Введите номер карты (минимум 12 цифр).';
        msgEl.style.display = 'block';
        return;
      }
      const rub = tokens * PROFILE_TOKEN_RATE_RUB;
      msgEl.className = 'msg ok';
      msgEl.textContent = 'Заявка на вывод принята (симуляция). ' + tokens + ' токенов = ' + rub + ' ₽ на карту ****' + card.slice(-4) + '. В реальной системе средства поступили бы в течение 1-3 рабочих дней.';
      msgEl.style.display = 'block';
      document.getElementById('profile-withdraw-tokens').value = '';
      document.getElementById('profile-withdraw-card').value = '';
      updateProfileWithdrawRub();
    };

    loadOverview();
  </script>
</body>
</html>
