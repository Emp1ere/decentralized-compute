<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Панель decentralized-compute</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --panel-2: #1f2937;
      --line: #334155;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --ok: #22c55e;
      --warn: #f59e0b;
      --err: #ef4444;
      --btn: #2563eb;
      --btn-hover: #1d4ed8;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 20px;
      background: var(--bg);
      color: var(--text);
      font: 14px/1.4 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }
    h1, h2, h3 { margin: 0 0 10px; }
    h1 { font-size: 22px; }
    h2 { font-size: 18px; }
    .layout {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      gap: 14px;
    }
    .card {
      border: 1px solid var(--line);
      background: var(--panel);
      border-radius: 10px;
      padding: 14px;
    }
    .row { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    .col { display: grid; gap: 10px; }
    .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)); gap: 14px; }
    .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 10px; }
    input, select, textarea, button {
      border-radius: 8px;
      border: 1px solid var(--line);
      background: var(--panel-2);
      color: var(--text);
      padding: 9px 10px;
      font: inherit;
    }
    textarea { min-height: 70px; resize: vertical; }
    button {
      cursor: pointer;
      background: var(--btn);
      border-color: transparent;
    }
    button:hover { background: var(--btn-hover); }
    .muted { color: var(--muted); }
    .status { font-weight: 600; }
    .ok { color: var(--ok); }
    .warn { color: var(--warn); }
    .err { color: var(--err); }
    .mono { font-family: ui-monospace, Menlo, Consolas, monospace; }
    .tabs { display: flex; flex-wrap: wrap; gap: 8px; }
    .tab-btn { background: #1e293b; }
    .tab-btn.active { background: #475569; }
    .tab { display: none; }
    .tab.active { display: block; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td {
      border-bottom: 1px solid var(--line);
      padding: 8px 6px;
      text-align: left;
      vertical-align: top;
    }
    .list {
      max-height: 280px;
      overflow: auto;
      border: 1px solid var(--line);
      border-radius: 8px;
      background: #0b1220;
      padding: 8px;
    }
    .log-line { margin: 0 0 4px; white-space: pre-wrap; }
    .small { font-size: 12px; }
    .field {
      display: grid;
      gap: 4px;
    }
    .field-label {
      font-size: 12px;
      color: var(--muted);
    }
    .hint {
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }
    .service-tools {
      border: 1px dashed var(--line);
      border-radius: 8px;
      padding: 10px;
      background: rgba(15, 23, 42, 0.45);
    }
    .service-tools > summary {
      cursor: pointer;
      font-weight: 600;
      color: var(--muted);
      outline: none;
      margin-bottom: 8px;
    }
    .table-responsive {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .detail-panel {
      background: #0b1220;
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 14px;
      margin-top: 12px;
      display: none;
    }
    .detail-panel.active { display: block; }
    .detail-meta { margin-bottom: 10px; }
    .detail-meta div { margin-bottom: 6px; }
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
      align-items: center;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      line-height: 1.5;
      border: 1px solid var(--line);
      white-space: nowrap;
    }
    .badge-reward { background: rgba(34, 197, 94, 0.16); color: #86efac; }
    .badge-work-receipt { background: rgba(37, 99, 235, 0.18); color: #93c5fd; }
    .badge-convert { background: rgba(14, 165, 233, 0.16); color: #67e8f9; }
    .badge-withdraw { background: rgba(245, 158, 11, 0.16); color: #fcd34d; }
    .badge-contract { background: rgba(168, 85, 247, 0.18); color: #d8b4fe; }
    .badge-default { background: rgba(148, 163, 184, 0.16); color: #cbd5e1; }
    .notice {
      border-radius: 8px;
      padding: 10px 12px;
      border: 1px solid var(--line);
      margin-top: 8px;
      background: #0b1220;
    }
    .notice.ok { border-color: rgba(34, 197, 94, 0.5); }
    .notice.warn { border-color: rgba(245, 158, 11, 0.5); }
    .notice.err { border-color: rgba(239, 68, 68, 0.5); }
    .toast {
      position: fixed;
      right: 20px;
      bottom: 20px;
      max-width: 440px;
      z-index: 99;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: #0b1220;
      padding: 10px 12px;
      display: none;
    }
    .toast.show { display: block; }
    .spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid #64748b;
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      vertical-align: middle;
      margin-left: 6px;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .stat-card {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px;
      background: #0b1220;
    }
    .stat-card .label { font-size: 12px; color: var(--muted); }
    .stat-card .value { font-size: 20px; font-weight: 700; margin-top: 3px; }
    .progress-wrap {
      height: 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #0b1220;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #2563eb, #22c55e);
      transition: width .2s ease;
    }
    .kv-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 8px 12px;
      margin-top: 10px;
    }
    .kv-item .k { color: var(--muted); font-size: 12px; }
    .kv-item .v { font-weight: 600; margin-top: 2px; word-break: break-word; }
    .mono-short { font-family: ui-monospace, Menlo, Consolas, monospace; font-size: 12px; }
    .expert-only { display: none !important; }
    body.expert-mode .expert-only { display: block !important; }
    body.expert-mode .expert-only.row { display: flex !important; }
    .operator-only { display: none !important; }
    body.expert-mode .operator-only { display: inline-block !important; }
    .badge-status-ok { background: rgba(34, 197, 94, 0.18); color: #86efac; }
    .badge-status-warn { background: rgba(245, 158, 11, 0.18); color: #fcd34d; }
    .badge-status-err { background: rgba(239, 68, 68, 0.18); color: #fca5a5; }
    .badge-status-muted { background: rgba(148, 163, 184, 0.16); color: #cbd5e1; }
  </style>
</head>
<body>
  <div class="layout">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <h1>Панель decentralized-compute</h1>
        <div class="row">
          <button id="btn-expert-mode" class="tab-btn">Режим эксперта: выкл</button>
          <span id="node-status" class="status muted">Узел: проверка...</span>
        </div>
      </div>
      <div class="tabs">
        <button class="tab-btn active" data-tab="tab-auth">Аккаунт</button>
        <button class="tab-btn" data-tab="tab-profile">Профиль</button>
        <button class="tab-btn" data-tab="tab-compute">Вычисления</button>
        <button class="tab-btn" data-tab="tab-market-jobs">Биржа</button>
        <button class="tab-btn" data-tab="tab-provider">Заказчик</button>
        <button class="tab-btn" data-tab="tab-market">Финансы и проверки</button>
        <button class="tab-btn" data-tab="tab-governance">Управление сетью</button>
        <button class="tab-btn" data-tab="tab-explorer">Эксплорер</button>
      </div>
    </div>

    <div id="tab-auth" class="tab active card">
      <h2>Аккаунт</h2>
      <div class="grid-2">
        <div class="col">
          <h3>Вход</h3>
          <input id="login-name" placeholder="логин">
          <input id="login-pass" type="password" placeholder="пароль">
          <button id="btn-login">Войти</button>
        </div>
        <div class="col">
          <h3>Регистрация</h3>
          <input id="reg-name" placeholder="логин">
          <input id="reg-pass" type="password" placeholder="пароль">
          <input id="reg-nick" placeholder="никнейм (необязательно)">
          <button id="btn-register">Создать аккаунт</button>
        </div>
      </div>
      <div class="card" style="margin-top:12px">
        <div><span class="muted">ID пользователя:</span> <span id="session-client" class="mono">-</span></div>
        <div><span class="muted">api_key:</span> <span id="session-key" class="mono">-</span></div>
        <div><span class="muted">баланс:</span> <span id="session-balance">-</span></div>
        <div style="margin-top:10px" class="row">
          <button id="btn-me">Обновить /me</button>
          <button id="btn-logout">Выйти</button>
        </div>
        <div style="margin-top:10px" class="row">
          <button id="btn-download-desktop-agent">Скачать desktop-agent (.zip)</button>
          <span class="small muted">Источник: `/download/desktop-agent`</span>
        </div>
      </div>
    </div>

    <div id="tab-profile" class="tab card">
      <h2>Профиль и активность</h2>
      <p class="hint">Здесь собраны ключевые данные профиля и ваш рабочий прогресс без технического шума.</p>
      <div class="row">
        <button id="btn-profile-refresh">Обновить профиль</button>
        <button id="btn-profile-logout">Выйти из аккаунта</button>
      </div>
      <div class="stats-grid">
        <div class="stat-card"><div class="label">Логин</div><div id="profile-login" class="value" style="font-size:16px">-</div></div>
        <div class="stat-card"><div class="label">Никнейм</div><div id="profile-nickname" class="value" style="font-size:16px">-</div></div>
        <div class="stat-card"><div class="label">Баланс (points)</div><div id="profile-balance" class="value">0</div></div>
        <div class="stat-card"><div class="label">Fiat эквивалент (RUB)</div><div id="profile-fiat-est" class="value">0</div></div>
        <div class="stat-card"><div class="label">Сдано работ</div><div id="profile-submissions" class="value">0</div></div>
      </div>
      <div class="card" style="margin-top:10px">
        <div class="muted small">ID пользователя</div>
        <div id="profile-client-id" class="mono-short">-</div>
        <div class="muted small" style="margin-top:8px">Fiat-кошелек</div>
        <div id="profile-fiat-wallet">-</div>
      </div>
      <div class="grid-2" style="margin-top:10px">
        <div class="card">
          <h3>Мои задачи</h3>
          <div class="stats-grid">
            <div class="stat-card"><div class="label">Всего</div><div id="jobs-total" class="value">0</div></div>
            <div class="stat-card"><div class="label">Активные</div><div id="jobs-active" class="value">0</div></div>
            <div class="stat-card"><div class="label">Ожидание валидации</div><div id="jobs-pending-validation" class="value">0</div></div>
            <div class="stat-card"><div class="label">Завершены</div><div id="jobs-finished" class="value">0</div></div>
          </div>
          <div class="table-responsive" style="margin-top:10px">
            <table>
              <thead><tr><th>ID задачи</th><th>Контракт</th><th>Статус</th><th>Прогресс</th><th>Обновлено</th></tr></thead>
              <tbody id="jobs-table-body"></tbody>
            </table>
          </div>
        </div>
        <div class="card">
          <h3>Мои устройства</h3>
          <div class="stats-grid">
            <div class="stat-card"><div class="label">Всего</div><div id="devices-total" class="value">0</div></div>
            <div class="stat-card"><div class="label">Активные</div><div id="devices-active" class="value">0</div></div>
            <div class="stat-card"><div class="label">Отключены</div><div id="devices-disabled" class="value">0</div></div>
          </div>
          <div class="table-responsive" style="margin-top:10px">
            <table>
              <thead><tr><th>device_id</th><th>Версия</th><th>Статус</th><th>Последний heartbeat</th></tr></thead>
              <tbody id="devices-table-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div id="tab-compute" class="tab card">
      <h2>Работа вычислителя</h2>
      <p class="muted">Здесь вы берете задачу, считаете результат и отправляете его. Если нужна допроверка, задача попадет в статус "ожидает проверки".</p>
      <div class="grid-3">
        <div class="field">
          <label class="field-label" for="compute-contract-id">ID контракта (опционально)</label>
          <input id="compute-contract-id" placeholder="если пусто - автоматический выбор">
        </div>
        <div class="field">
          <label class="field-label" for="compute-sector-id">sector_id (опционально)</label>
          <input id="compute-sector-id" placeholder="например sec-...">
        </div>
        <div class="field">
          <label class="field-label" for="compute-scheduler-profile">Профиль планировщика</label>
          <select id="compute-scheduler-profile">
            <option value="adaptive">adaptive</option>
            <option value="balanced">balanced</option>
            <option value="performance">performance</option>
            <option value="eco">eco</option>
          </select>
        </div>
      </div>
      <div class="row">
        <button id="btn-get-task">Взять задачу</button>
        <button id="btn-compute-submit">Посчитать и отправить</button>
      </div>
      <div id="compute-status-human" class="notice muted">Ожидание действий.</div>
      <div class="stats-grid">
        <div class="stat-card"><div class="label">Текущий контракт</div><div id="compute-contract-value" class="value" style="font-size:16px">-</div></div>
        <div class="stat-card"><div class="label">Текущий job</div><div id="compute-job-value" class="value" style="font-size:16px">-</div></div>
        <div class="stat-card"><div class="label">Статус шага</div><div id="compute-step-status" class="value" style="font-size:16px">Ожидание</div></div>
        <div class="stat-card"><div class="label">Последняя награда</div><div id="compute-last-reward" class="value" style="font-size:16px">-</div></div>
      </div>
      <div class="card" style="margin-top:10px">
        <div class="row" style="justify-content:space-between">
          <div class="muted small">Прогресс текущего job</div>
          <div id="compute-progress-label" class="small">0%</div>
        </div>
        <div class="progress-wrap"><div id="compute-progress-bar" class="progress-bar"></div></div>
        <div class="kv-grid">
          <div class="kv-item"><div class="k">Режим проверки</div><div id="compute-validation-mode" class="v">-</div></div>
          <div class="kv-item"><div class="k">Кворум / репликация</div><div id="compute-quorum" class="v">-</div></div>
          <div class="kv-item"><div class="k">Единиц работы</div><div id="compute-units" class="v">-</div></div>
          <div class="kv-item"><div class="k">Тип вычислений</div><div id="compute-type" class="v">-</div></div>
        </div>
      </div>
      <details class="service-tools" style="margin-top:10px">
        <summary>Сервисный режим (тесты и диагностика): быстрый запуск воркера на сервере</summary>
        <p class="hint">Используйте только при отладке. Для обычной работы предпочтителен Desktop-agent на вашей машине.</p>
        <div class="row">
          <div class="field">
            <label class="field-label" for="worker-run-contract">Контракт для запуска</label>
            <select id="worker-run-contract"></select>
          </div>
          <div class="field">
            <label class="field-label" for="worker-run-manual-contract">Или введите ID контракта вручную</label>
            <input id="worker-run-manual-contract" placeholder="ID контракта (если нет в списке)">
          </div>
          <label class="small"><input id="worker-run-once" type="checkbox"> run_once (один цикл)</label>
        </div>
        <div class="row">
          <button id="btn-run-worker">Запустить воркер</button>
          <button id="btn-worker-progress-refresh">Обновить прогресс воркера</button>
        </div>
        <pre id="run-worker-json" class="mono small">-</pre>
        <pre id="worker-progress-json" class="mono small">-</pre>
      </details>
      <details class="card expert-only" style="margin-top:10px">
        <summary>Технические детали (структурные данные + журнал)</summary>
        <div class="small muted" style="margin-top:8px">Текущая задача</div>
        <pre id="task-json" class="mono small">-</pre>
        <div class="small muted">Результат отправки</div>
        <pre id="submit-json" class="mono small">-</pre>
        <div class="list" id="compute-log"></div>
      </details>
      <div class="grid-2" style="margin-top:10px">
        <div class="card col">
          <h3>Оспаривание результата по задаче</h3>
          <input id="challenge-job-id" placeholder="ID задачи">
          <input id="challenge-reason" placeholder="причина (необязательно)">
          <div class="row">
            <button id="btn-open-challenge">Открыть спор</button>
            <button id="btn-finalize-challenge-window">Завершить окно оспаривания</button>
          </div>
          <pre id="challenge-json" class="mono small">-</pre>
        </div>
        <div class="card col">
          <h3>Решение по спору (заказчик)</h3>
          <input id="challenge-id" placeholder="challenge_id (идентификатор challenge)">
          <select id="challenge-decision">
            <option value="accept_worker">accept_worker</option>
            <option value="reject_worker">reject_worker</option>
          </select>
          <button id="btn-resolve-challenge">Решить</button>
          <pre id="challenge-resolve-json" class="mono small">-</pre>
        </div>
      </div>
      <div class="card col" style="margin-top:10px">
        <h3>Управление спором</h3>
        <div class="row">
          <input id="dispute-id" placeholder="ID спора">
          <button id="btn-dispute-get">Открыть карточку спора</button>
        </div>
        <div class="row">
          <input id="dispute-event" placeholder="событие (например: start_review)">
          <input id="dispute-payload-json" placeholder='данные события (необязательно), пример: {"note":"manual"}'>
          <button id="btn-dispute-event">Отправить событие</button>
        </div>
        <pre id="dispute-json" class="mono small">-</pre>
      </div>
      <div class="grid-2" style="margin-top:10px">
        <div class="card col expert-only">
          <h3>Мои устройства</h3>
          <button id="btn-devices-refresh">Обновить устройства</button>
          <pre id="devices-json" class="mono small">-</pre>
        </div>
        <div class="card col expert-only">
          <h3>Мои задачи</h3>
          <button id="btn-jobs-refresh">Обновить задачи</button>
          <pre id="jobs-json" class="mono small">-</pre>
        </div>
      </div>
    </div>

    <div id="tab-market-jobs" class="tab card">
      <h2>Биржа</h2>
      <p class="hint">Доступные задачи (контракты) для взятия. Выберите задачу и нажмите «Взять».</p>
      <div class="row">
        <button id="btn-market-jobs-refresh">Обновить список</button>
      </div>
      <div class="table-responsive" style="margin-top:12px">
        <table id="market-jobs-table">
          <thead><tr><th>Контракт</th><th>Сектор</th><th>Награда</th><th>Ед. работы</th><th>Тип вычислений</th><th>Действие</th></tr></thead>
          <tbody id="market-jobs-tbody"></tbody>
        </table>
      </div>
      <div id="market-jobs-empty" class="muted small" style="margin-top:12px;display:none">Нет доступных задач.</div>
    </div>

    <div id="tab-provider" class="tab card">
      <h2>Контракты заказчика</h2>
      <div class="grid-2">
        <div class="col card">
          <h3>Создать сектор</h3>
          <input id="sector-name" placeholder="название сектора (sector_name)">
          <input id="sector-org" placeholder="организация (organization_name)">
          <input id="sector-domain" placeholder="домен вычислений (compute_domain)">
          <textarea id="sector-desc" placeholder="описание"></textarea>
          <button id="btn-sector-create">Создать сектор</button>
        </div>
        <div class="col card">
          <h3>Создать контракт</h3>
          <div class="field">
            <label class="field-label" for="contract-sector">Сектор</label>
            <select id="contract-sector"></select>
          </div>
          <div class="field">
            <label class="field-label" for="contract-name">Название задачи</label>
            <input id="contract-name" placeholder="название задачи (task_name)">
          </div>
          <div class="field">
            <label class="field-label" for="contract-category">Категория задачи</label>
            <input id="contract-category" placeholder="категория задачи (например AI/Simulation)">
          </div>
          <div class="field">
            <label class="field-label" for="contract-compute-type">Тип вычислений (computation_type)</label>
            <select id="contract-compute-type"></select>
          </div>
          <div class="field">
            <label class="field-label" for="contract-task-class">Класс задачи (task_class)</label>
            <select id="contract-task-class">
              <option value="">авто-выбор task_class</option>
            </select>
          </div>
          <div class="field">
            <label class="field-label" for="contract-workload-preset">Прикладной пресет (форматы + chunking)</label>
            <select id="contract-workload-preset">
              <option value="">без пресета</option>
            </select>
            <div class="hint">Пресет добавит рекомендации по форматам входа/выхода и профилю чанкования в benchmark_meta.</div>
          </div>
          <div class="grid-3">
            <div class="field">
              <label class="field-label" for="contract-units">Единиц на задачу</label>
              <input id="contract-units" type="number" value="1000" min="1" placeholder="work_units_required">
            </div>
            <div class="field">
              <label class="field-label" for="contract-reward">Награда за задачу</label>
              <input id="contract-reward" type="number" value="10" min="1" placeholder="reward_per_task">
            </div>
            <div class="field">
              <label class="field-label" for="contract-target">Целевой объем работ</label>
              <input id="contract-target" type="number" value="10000" min="1" placeholder="target_total_work_units">
            </div>
          </div>
          <div class="grid-3">
            <div class="field">
              <label class="field-label" for="contract-difficulty">Сложность</label>
              <input id="contract-difficulty" type="number" value="3" min="1" max="8" placeholder="difficulty 1..8">
            </div>
            <div class="field">
              <label class="field-label" for="contract-budget">Начальный бюджет</label>
              <input id="contract-budget" type="number" value="0" min="0" placeholder="initial_budget_tokens">
            </div>
            <div class="field">
              <label class="field-label" for="contract-currency">Валюта бюджета</label>
              <select id="contract-currency">
                <option>RUB</option><option>USD</option><option>EUR</option>
              </select>
            </div>
          </div>
          <label class="small"><input id="contract-activate-now" type="checkbox"> Активировать контракт сразу после создания</label>
          <div class="field">
            <label class="field-label" for="contract-desc">Описание задачи</label>
            <textarea id="contract-desc" placeholder="описание задачи (task_description)"></textarea>
          </div>
          <button id="btn-contract-create">Создать контракт</button>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="btn-provider-refresh">Обновить секторы/контракты</button>
      </div>
      <div class="grid-2" style="margin-top:10px">
        <div class="card">
          <h3>Секторы</h3>
          <pre id="sectors-json" class="mono small">[]</pre>
        </div>
        <div class="card">
          <h3>Контракты</h3>
          <pre id="provider-contracts-json" class="mono small">[]</pre>
        </div>
      </div>
      <div class="card col" style="margin-top:10px">
        <h3>Управление контрактом: статус / пополнение / возврат</h3>
        <div class="field">
          <label class="field-label" for="manage-contract-id">Контракт</label>
          <select id="manage-contract-id"></select>
        </div>
        <div class="row">
          <button id="btn-contract-status-active">Статус active</button>
          <button id="btn-contract-status-paused">Статус paused</button>
          <button id="btn-contract-status-closed">Статус closed</button>
        </div>
        <div class="row">
          <div class="field">
            <label class="field-label" for="fund-amount">Сумма пополнения</label>
            <input id="fund-amount" type="number" min="1" value="1000" placeholder="сумма пополнения">
          </div>
          <div class="field">
            <label class="field-label" for="fund-currency">Валюта</label>
            <select id="fund-currency"><option>RUB</option><option>USD</option><option>EUR</option></select>
          </div>
          <button id="btn-contract-fund">Пополнить</button>
        </div>
        <div class="row">
          <div class="field">
            <label class="field-label" for="refund-amount">Сумма возврата</label>
            <input id="refund-amount" type="number" min="0" placeholder="сумма возврата (пусто = максимум)">
          </div>
          <button id="btn-contract-refund">Вернуть</button>
        </div>
        <pre id="manage-contract-json" class="mono small">-</pre>
      </div>
      <div class="card col" style="margin-top:10px">
        <h3>Итоговые результаты контракта</h3>
        <p class="hint">Сначала получите live-срез, затем зафиксируйте итоговый снимок и скачайте ZIP.</p>
        <div class="row">
          <button id="btn-results-live">Обновить live-результаты</button>
          <button id="btn-results-finalize">Зафиксировать итог</button>
          <button id="btn-results-download">Скачать ZIP итогов</button>
        </div>
        <pre id="results-json" class="mono small">-</pre>
      </div>
      <div class="card col" style="margin-top:10px">
        <h3>Ingestion и чанкование (прикладные данные)</h3>
        <p class="hint">Шаги: 1) загрузить manifest (форматы и объем), 2) опубликовать chunk plan на биржу jobs.</p>
        <div class="grid-3">
          <div class="field">
            <label class="field-label" for="ingestion-contract-id">Контракт</label>
            <select id="ingestion-contract-id"></select>
          </div>
          <div class="field">
            <label class="field-label" for="ingestion-total-units">Общий объем (total_units)</label>
            <input id="ingestion-total-units" type="number" min="1" value="100000">
          </div>
          <div class="field">
            <label class="field-label" for="ingestion-chunk-size">Размер чанка (chunk_size)</label>
            <input id="ingestion-chunk-size" type="number" min="1" value="10000">
          </div>
        </div>
        <div class="field">
          <label class="field-label" for="ingestion-files">Файлы источника (file/files)</label>
          <input id="ingestion-files" type="file" multiple>
          <div class="hint">Для боевого ingest: загрузите 1+ файла, total_units рассчитается автоматически по реальному размеру.</div>
        </div>
        <div class="field">
          <label class="field-label" for="ingestion-artifacts-json">dataset_artifacts JSON</label>
          <textarea id="ingestion-artifacts-json" placeholder='[{"name":"dataset.parquet","uri":"s3://bucket/dataset.parquet","sha256":"...64hex...","size_bytes":123}]'></textarea>
        </div>
        <div class="field">
          <label class="field-label" for="model1-source-path">Локальный путь source (для Model_1 bootstrap)</label>
          <input id="model1-source-path" placeholder="C:\Users\Alexandra\Downloads\benchPEP\benchPEP.tpr">
        </div>
        <div class="row">
          <button id="btn-ingestion-manifest">Сохранить manifest и chunk plan</button>
          <button id="btn-ingestion-upload">Загрузить файл(ы) и автосчитать план</button>
          <button id="btn-ingestion-publish">Опубликовать chunk plan</button>
          <button id="btn-ingestion-refresh">Обновить ingestion статус</button>
          <button id="btn-model1-bootstrap">Связать с Model_1</button>
        </div>
        <pre id="ingestion-json" class="mono small">-</pre>
      </div>
    </div>

    <div id="tab-market" class="tab card">
      <h2>Финансы и проверка операций</h2>
      <p class="hint">Здесь вы управляете балансом, конвертацией и выводом. Для некоторых операций система выполняет проверки рисков (KYC/AML).</p>
      <div class="grid-2">
        <div class="col card">
          <h3>Кошелек</h3>
          <p class="hint">Ваши текущие балансы по валютам.</p>
          <button id="btn-wallet-refresh">Обновить кошелек</button>
          <div id="wallet-status" class="status" style="margin-top:8px">—</div>
          <details class="expert-only" style="margin-top:8px">
            <summary class="small muted">Технические детали (JSON)</summary>
            <pre id="wallet-json" class="mono small">-</pre>
          </details>
          <div class="row">
            <div class="field">
              <label class="field-label" for="topup-amount">Сумма пополнения</label>
              <input id="topup-amount" type="number" min="1" value="1000" placeholder="сумма">
            </div>
            <div class="field">
              <label class="field-label" for="topup-currency">Валюта пополнения</label>
              <select id="topup-currency"><option>RUB</option><option>USD</option><option>EUR</option></select>
            </div>
            <button id="btn-topup">Пополнить</button>
          </div>
        </div>
        <div class="col card">
          <h3>Конвертация</h3>
          <p class="hint">Обмен валют внутри кошелька по текущим правилам сети.</p>
          <div class="row">
            <div class="field">
              <label class="field-label" for="convert-from">Из валюты</label>
              <select id="convert-from"><option>RUB</option><option>USD</option><option>EUR</option></select>
            </div>
            <div class="field">
              <label class="field-label" for="convert-to">В валюту</label>
              <select id="convert-to"><option>USD</option><option>EUR</option><option>RUB</option></select>
            </div>
            <div class="field">
              <label class="field-label" for="convert-amount">Сумма</label>
              <input id="convert-amount" type="number" value="100" min="1">
            </div>
            <div class="field">
              <label class="field-label" for="convert-country">Country code</label>
              <input id="convert-country" placeholder="например RU, KZ (необязательно)">
            </div>
          </div>
          <button id="btn-convert">Конвертировать</button>
          <div id="convert-status" class="status" style="margin-top:8px">—</div>
          <details class="expert-only" style="margin-top:8px">
            <summary class="small muted">Технические детали (JSON)</summary>
            <pre id="convert-json" class="mono small">-</pre>
          </details>
        </div>
      </div>
      <div class="grid-2" style="margin-top:10px">
        <div class="col card">
          <h3>Вывод</h3>
          <p class="hint">Создание заявки на вывод средств на банковскую карту.</p>
          <div class="row">
            <div class="field">
              <label class="field-label" for="wd-currency">Валюта вывода</label>
              <select id="wd-currency"><option>RUB</option><option>USD</option><option>EUR</option></select>
            </div>
            <div class="field">
              <label class="field-label" for="wd-amount">Сумма вывода</label>
              <input id="wd-amount" type="number" value="100" min="1">
            </div>
            <div class="field">
              <label class="field-label" for="wd-card">Номер карты</label>
              <input id="wd-card" placeholder="номер карты">
            </div>
            <div class="field">
              <label class="field-label" for="wd-country">Country code</label>
              <input id="wd-country" placeholder="например RU, KZ (необязательно)">
            </div>
          </div>
          <button id="btn-withdraw">Создать вывод</button>
          <pre id="withdraw-json" class="mono small">-</pre>
          <button id="btn-withdraw-list">Обновить выводы</button>
          <pre id="withdraw-list-json" class="mono small">-</pre>
        </div>
        <div class="col card">
          <h3>Проверка операции (KYC/AML)</h3>
          <p class="hint">Показывает, пройдет ли операция проверки риска до реальной отправки.</p>
          <div class="row">
            <div class="field">
              <label class="field-label" for="cmp-op">Тип операции</label>
              <select id="cmp-op">
                <option value="withdrawal">Вывод средств (withdrawal)</option>
                <option value="convert">Конвертация (convert)</option>
              </select>
            </div>
            <div class="field">
              <label class="field-label" for="cmp-amount">Сумма операции</label>
              <input id="cmp-amount" type="number" value="100">
            </div>
            <div class="field">
              <label class="field-label" for="cmp-currency">Валюта операции</label>
              <select id="cmp-currency"><option>RUB</option><option>USD</option><option>EUR</option></select>
            </div>
            <div class="field">
              <label class="field-label" for="cmp-country">Country code</label>
              <input id="cmp-country" placeholder="например RU, KZ">
            </div>
          </div>
          <button id="btn-compliance-evaluate">Проверить риск</button>
          <pre id="compliance-json" class="mono small">-</pre>
        </div>
      </div>
      <div class="grid-2" style="margin-top:10px">
        <div class="col card">
          <h3>Курсовые оракулы</h3>
          <div class="row">
            <button id="btn-fx-oracles-refresh">Статус оракулов</button>
            <button id="btn-fx-epoch-refresh">Текущая эпоха</button>
            <button id="btn-fx-finalize" class="operator-only">Финализировать эпоху</button>
          </div>
          <div class="stats-grid">
            <div class="stat-card"><div class="label">USD->RUB</div><div id="fx-rate-usd" class="value" style="font-size:16px">-</div></div>
            <div class="stat-card"><div class="label">EUR->RUB</div><div id="fx-rate-eur" class="value" style="font-size:16px">-</div></div>
            <div class="stat-card"><div class="label">Уверенность</div><div id="fx-confidence" class="value" style="font-size:16px">-</div></div>
            <div class="stat-card"><div class="label">Волатильность</div><div id="fx-volatility" class="value" style="font-size:16px">-</div></div>
          </div>
          <div class="table-responsive" style="margin-top:10px">
            <table>
              <thead><tr><th>Оракул</th><th>Счёт</th><th>Штрафы</th></tr></thead>
              <tbody id="fx-oracles-table-body"></tbody>
            </table>
          </div>
          <details class="expert-only" style="margin-top:8px">
            <summary class="small muted">Технические детали (структурные данные)</summary>
            <pre id="fx-oracles-json" class="mono small">-</pre>
            <pre id="fx-epoch-json" class="mono small">-</pre>
          </details>
        </div>
        <div class="col card">
          <h3>Казначейство и выплаты</h3>
          <div class="row">
            <button id="btn-treasury-refresh">Обновить treasury</button>
            <button id="btn-payments-dispatch" class="operator-only">Запустить выплаты</button>
            <button id="btn-payments-reconcile">Сверка</button>
          </div>
          <div class="stats-grid">
            <div class="stat-card"><div class="label">RUB резерв</div><div id="treasury-rub" class="value" style="font-size:16px">-</div></div>
            <div class="stat-card"><div class="label">USD резерв</div><div id="treasury-usd" class="value" style="font-size:16px">-</div></div>
            <div class="stat-card"><div class="label">EUR резерв</div><div id="treasury-eur" class="value" style="font-size:16px">-</div></div>
            <div class="stat-card"><div class="label">Буфер RUB</div><div id="treasury-buffer-rub" class="value" style="font-size:16px">-</div></div>
          </div>
          <div class="table-responsive" style="margin-top:10px">
            <table>
              <thead><tr><th>Операция</th><th>Сумма</th><th>Статус</th><th>Повторы</th><th>Ссылка провайдера</th><th>Обновлено</th></tr></thead>
              <tbody id="payments-ops-table-body"></tbody>
            </table>
          </div>
          <div class="table-responsive" style="margin-top:10px">
            <table>
              <thead><tr><th>Сверка</th><th>Проверено</th><th>Несовпадений</th><th>Время</th></tr></thead>
              <tbody id="payments-reconcile-table-body"></tbody>
            </table>
          </div>
          <details class="expert-only" style="margin-top:8px">
            <summary class="small muted">Технические детали (структурные данные)</summary>
            <pre id="treasury-json" class="mono small">-</pre>
            <pre id="payments-dispatch-json" class="mono small">-</pre>
          </details>
        </div>
      </div>
      <div class="grid-2" style="margin-top:10px">
        <div class="col card">
          <h3>Кейсы проверок</h3>
          <p class="hint">Список кейсов проверки операций с фильтром по статусу.</p>
          <div class="row">
            <div class="field">
              <label class="field-label" for="provider-cases-status">Фильтр статуса</label>
              <select id="provider-cases-status">
                <option value="">Все</option>
                <option value="pending">ожидает</option>
                <option value="in_review">на ручной проверке</option>
                <option value="allow">разрешено</option>
                <option value="review">нужна ручная проверка</option>
                <option value="reject">отклонено</option>
              </select>
            </div>
            <button id="btn-provider-cases-refresh">Обновить кейсы</button>
          </div>
          <div class="table-responsive">
            <table>
              <thead><tr><th>Кейс</th><th>Операция</th><th>Сумма</th><th>Статус</th><th>Решение</th><th>Обновлено</th></tr></thead>
              <tbody id="provider-cases-table-body"></tbody>
            </table>
          </div>
          <details class="expert-only" style="margin-top:8px">
            <summary class="small muted">Технические детали (структурные данные)</summary>
            <pre id="provider-cases-json" class="mono small">-</pre>
          </details>
        </div>
        <div class="col card">
          <h3>События проверки операций</h3>
          <p class="hint">Лента входящих событий. Кнопка "Запустить обработку" запускает обработчик событий в симуляторе.</p>
          <div class="row">
            <button id="btn-provider-webhooks-dispatch">Запустить обработку</button>
            <button id="btn-provider-webhooks-refresh">Обновить ленту</button>
          </div>
          <div class="table-responsive">
            <table>
              <thead><tr><th>Время</th><th>Кейс</th><th>Событие</th><th>Решение</th><th>Статус</th></tr></thead>
              <tbody id="provider-webhooks-table-body"></tbody>
            </table>
          </div>
          <details class="expert-only" style="margin-top:8px">
            <summary class="small muted">Технические детали (структурные данные)</summary>
            <pre id="provider-webhooks-json" class="mono small">-</pre>
          </details>
        </div>
      </div>
    </div>

    <div id="tab-governance" class="tab card">
      <h2>Управление сетью</h2>
      <p class="hint">Раздел для подключения узлов, валидаторов и обновления версии протокола.</p>
      <div class="row">
        <button id="btn-gov-info">Показать статус сети</button>
      </div>
      <div class="stats-grid">
        <div class="stat-card"><div class="label">Версия протокола</div><div id="gov-protocol-version" class="value" style="font-size:16px">-</div></div>
        <div class="stat-card"><div class="label">Подключено узлов</div><div id="gov-nodes-count" class="value">0</div></div>
        <div class="stat-card"><div class="label">Подключено валидаторов</div><div id="gov-validators-count" class="value">0</div></div>
        <div class="stat-card"><div class="label">Статус обновления</div><div id="gov-rollout-status" class="value" style="font-size:16px">-</div></div>
      </div>
      <details class="expert-only" style="margin-top:8px">
        <summary class="small muted">Технические детали (структурные данные)</summary>
        <pre id="gov-json" class="mono small">-</pre>
      </details>
      <div class="grid-2">
        <div class="card col">
          <h3>Добавить валидатора</h3>
          <p class="hint">Валидатор участвует в независимой проверке результатов вычислений.</p>
          <div class="field">
            <label class="field-label" for="val-id">ID пользователя, которого нужно сделать валидатором</label>
            <input id="val-id" placeholder="ID валидатора">
          </div>
          <button id="btn-admit-validator">Добавить валидатора</button>
          <pre id="val-admit-json" class="mono small">-</pre>
        </div>
        <div class="card col">
          <h3>Решение валидатора по группе репликации</h3>
          <p class="hint">Используйте при спорных или неоднозначных результатах.</p>
          <div class="field">
            <label class="field-label" for="verdict-group">ID группы репликации</label>
            <input id="verdict-group" placeholder="replication_group_id">
          </div>
          <div class="field">
            <label class="field-label" for="verdict-value">Решение</label>
            <select id="verdict-value">
              <option value="accepted">Принять результат (accepted)</option>
              <option value="rejected">Отклонить результат (rejected)</option>
            </select>
          </div>
          <div class="field">
            <label class="field-label" for="verdict-note">Комментарий</label>
            <input id="verdict-note" placeholder="пояснение (необязательно)">
          </div>
          <button id="btn-verdict-submit">Отправить решение</button>
          <pre id="verdict-json" class="mono small">-</pre>
        </div>
      </div>
      <div class="grid-2" style="margin-top:10px">
        <div class="card col">
          <h3>Добавить узел в сеть</h3>
          <p class="hint">Используется при подключении нового узла к управляемой сети.</p>
          <div class="field">
            <label class="field-label" for="gov-node-id">ID узла</label>
            <input id="gov-node-id" placeholder="например orchestrator_node_2">
          </div>
          <div class="field">
            <label class="field-label" for="gov-admission-token">Admission token (если включен на сервере)</label>
            <input id="gov-admission-token" placeholder="необязательно">
          </div>
          <button id="btn-gov-admit-node">Добавить узел</button>
          <pre id="gov-admit-node-json" class="mono small">-</pre>
        </div>
        <div class="card col">
          <h3>Обновление версии протокола</h3>
          <p class="hint">Этапы: предложить версию -> подтвердить -> финализировать.</p>
          <div class="field">
            <label class="field-label" for="gov-rollout-version">Версия протокола</label>
            <select id="gov-rollout-version"></select>
          </div>
          <div class="field">
            <label class="field-label" for="gov-rollout-required-acks">Минимум подтверждений</label>
            <input id="gov-rollout-required-acks" type="number" min="1" value="1">
          </div>
          <div class="row">
            <button id="btn-gov-rollout-propose">Предложить обновление</button>
            <button id="btn-gov-rollout-ack">Подтвердить</button>
            <button id="btn-gov-rollout-finalize">Финализировать</button>
          </div>
          <pre id="gov-rollout-json" class="mono small">-</pre>
        </div>
      </div>
      <div class="card col" style="margin-top:10px">
        <h3>Аргументация MVP (решение -> риск -> proof-point)</h3>
        <div class="row">
          <button id="btn-claims-refresh">Обновить claims</button>
          <button id="btn-demo-script-refresh">Показать demo-script</button>
          <button id="btn-demo-seed">Подготовить demo-данные (dev-only)</button>
        </div>
        <pre id="claims-json" class="mono small">-</pre>
        <pre id="demo-script-json" class="mono small">-</pre>
        <pre id="demo-seed-json" class="mono small">-</pre>
      </div>
    </div>

    <div id="tab-explorer" class="tab card">
      <h2>Эксплорер</h2>
      <div class="row">
        <button id="btn-explorer-refresh">Обновить данные</button>
        <span class="muted small">Полный режим внутри дашборда</span>
      </div>
      <div class="grid-3">
        <div class="card"><div class="muted small">Длина цепочки</div><div id="ex-chain-len" class="status">-</div></div>
        <div class="card"><div class="muted small">Последний блок</div><div id="ex-last-index" class="status">-</div></div>
        <div class="card"><div class="muted small">Транзакций в pending</div><div id="ex-pending" class="status">-</div></div>
      </div>
      <div class="card" style="margin-top:10px">
        <h3>Поиск блока по индексу</h3>
        <div class="row">
          <input id="ex-search-block-index" type="number" min="0" placeholder="Индекс блока">
          <button id="btn-ex-paste-block-index">Вставить</button>
          <button id="btn-ex-search-block">Показать блок</button>
          <span id="ex-block-search-msg" class="small err" style="display:none;"></span>
        </div>
      </div>
      <div class="card" style="margin-top:10px">
        <h3>Последние блоки</h3>
        <div class="table-responsive">
        <table>
          <thead>
            <tr>
              <th>Индекс</th>
              <th>Хеш</th>
              <th>Транзакций</th>
              <th>Время</th>
            </tr>
          </thead>
          <tbody id="ex-blocks-table-body"></tbody>
        </table>
        </div>
      </div>
      <div id="ex-block-detail" class="detail-panel">
        <h3 style="margin-top:0;">Блок <span id="ex-detail-index"></span></h3>
        <div class="detail-meta">
          <div><span class="muted">Хеш:</span> <span id="ex-detail-hash" class="mono"></span></div>
          <div><span class="muted">Предыдущий хеш:</span> <span id="ex-detail-prev" class="mono"></span></div>
          <div><span class="muted">Время:</span> <span id="ex-detail-time"></span></div>
          <div><span class="muted">Транзакций:</span> <span id="ex-detail-tx-count"></span></div>
        </div>
        <div class="filters">
          <select id="ex-detail-filter-type">
            <option value="">Все типы tx</option>
            <option value="reward">Награда</option>
            <option value="work_receipt">Подтверждение работы</option>
            <option value="fiat_topup">Пополнение</option>
            <option value="fiat_withdrawal_request">Заявка на вывод</option>
            <option value="fiat_conversion">Конвертация</option>
            <option value="contract_reward_settlement">Выплата по контракту</option>
            <option value="contract_create_event">Создание контракта</option>
            <option value="contract_budget_fund_event">Пополнение бюджета контракта</option>
            <option value="contract_budget_refund_event">Возврат бюджета контракта</option>
            <option value="contract_status_event">Событие статуса контракта</option>
            <option value="contract_worker_escrow_hold">Резерв эскроу</option>
            <option value="contract_worker_escrow_release">Освобождение эскроу</option>
            <option value="contract_worker_escrow_penalty">Штраф эскроу</option>
          </select>
          <input id="ex-detail-filter-contract" placeholder="Фильтр по ID контракта">
          <button id="btn-ex-detail-filter-clear">Сброс</button>
        </div>
        <div class="table-responsive">
          <table>
            <thead><tr><th>Тип</th><th>От / Вычислитель</th><th>Кому</th><th>Сумма / Комиссия</th><th>Контракт</th><th>Ед. работы</th></tr></thead>
            <tbody id="ex-detail-tx-body"></tbody>
          </table>
        </div>
      </div>
      <div class="card" style="margin-top:10px">
        <h3>Поиск по адресу пользователя</h3>
        <div class="row">
          <input id="ex-search-address" placeholder="UUID пользователя">
          <button id="btn-ex-paste-address">Вставить</button>
          <button id="btn-ex-search-address">Показать адрес</button>
          <span id="ex-address-msg" class="small err" style="display:none;"></span>
        </div>
      </div>
      <div id="ex-address-detail" class="detail-panel">
        <h3 style="margin-top:0;">Адрес <span id="ex-addr-client-id" class="mono"></span></h3>
        <div class="detail-meta">
          <div><span class="muted">Fiat-кошелек:</span> <span id="ex-addr-fiat-wallet"></span></div>
          <div><span class="muted">Эквивалент (RUB):</span> <span id="ex-addr-fiat-rub-estimate"></span></div>
          <div><span class="muted">Chain points:</span> <span id="ex-addr-chain-points"></span></div>
          <div><span class="muted">Транзакций:</span> <span id="ex-addr-tx-count"></span></div>
        </div>
        <div class="filters">
          <select id="ex-address-filter-type">
            <option value="">Все типы tx</option>
            <option value="reward">Награда</option>
            <option value="work_receipt">Подтверждение работы</option>
            <option value="fiat_topup">Пополнение</option>
            <option value="fiat_withdrawal_request">Заявка на вывод</option>
            <option value="fiat_conversion">Конвертация</option>
            <option value="contract_reward_settlement">Выплата по контракту</option>
            <option value="contract_create_event">Создание контракта</option>
            <option value="contract_budget_fund_event">Пополнение бюджета контракта</option>
            <option value="contract_budget_refund_event">Возврат бюджета контракта</option>
            <option value="contract_status_event">Событие статуса контракта</option>
            <option value="contract_worker_escrow_hold">Резерв эскроу</option>
            <option value="contract_worker_escrow_release">Освобождение эскроу</option>
            <option value="contract_worker_escrow_penalty">Штраф эскроу</option>
          </select>
          <input id="ex-address-filter-contract" placeholder="Фильтр по ID контракта">
          <button id="btn-ex-address-filter-clear">Сброс</button>
        </div>
        <div class="table-responsive">
          <table>
            <thead><tr><th>Блок</th><th>Тип</th><th>Детали</th></tr></thead>
            <tbody id="ex-address-tx-body"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <div id="toast" class="toast"></div>

  <script>
    const STORAGE_KEY = "dcc_dashboard_auth_v2";
    const UI_PREFS_KEY = "dcc_dashboard_ui_v1";

    function loadUiPrefs() {
      try {
        const raw = localStorage.getItem(UI_PREFS_KEY);
        if (!raw) return { expert_mode: false };
        const parsed = JSON.parse(raw);
        return {
          expert_mode: Boolean(parsed.expert_mode),
        };
      } catch {
        return { expert_mode: false };
      }
    }

    const state = {
      auth: loadAuth(),
      ui: loadUiPrefs(),
      task: null,
      explorer: {
        currentBlock: null,
        currentAddressPayload: null,
      },
    };

    const $ = (id) => document.getElementById(id);
    const pp = (v) => JSON.stringify(v, null, 2);

    function loadAuth() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return { api_key: "", client_id: "" };
        const parsed = JSON.parse(raw);
        return {
          api_key: String(parsed.api_key || ""),
          client_id: String(parsed.client_id || ""),
        };
      } catch {
        return { api_key: "", client_id: "" };
      }
    }

    function saveAuth() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state.auth));
      renderSession();
    }

    function saveUiPrefs() {
      localStorage.setItem(UI_PREFS_KEY, JSON.stringify(state.ui));
    }

    function applyExpertMode() {
      const enabled = Boolean(state.ui?.expert_mode);
      document.body.classList.toggle("expert-mode", enabled);
      const btn = $("btn-expert-mode");
      if (btn) btn.textContent = `Режим эксперта: ${enabled ? "вкл" : "выкл"}`;
    }

    function authHeaders() {
      if (!state.auth.api_key) return {};
      return { Authorization: `Bearer ${state.auth.api_key}` };
    }

    function showToast(message, level = "ok") {
      const toast = $("toast");
      toast.textContent = message;
      toast.className = `toast show ${level}`;
      setTimeout(() => {
        toast.className = "toast";
      }, 3200);
    }

    function setHumanStatus(message, level = "muted") {
      const el = $("compute-status-human");
      if (!el) return;
      el.textContent = message;
      el.className = `notice ${level}`;
    }

    function toUserError(body, fallback = "Ошибка запроса") {
      if (body && typeof body === "object") {
        if (body.user_message) return String(body.user_message);
        if (body.error) return String(body.error);
      }
      return fallback;
    }

    async function api(path, { method = "GET", payload = null, retries = 0 } = {}) {
      let lastErr = null;
      for (let attempt = 0; attempt <= retries; attempt += 1) {
        const res = await fetch(path, {
          method,
          headers: {
            "Content-Type": "application/json",
            ...authHeaders(),
          },
          body: payload ? JSON.stringify(payload) : null,
        });
        let body = {};
        try { body = await res.json(); } catch {}
        if (res.ok) return { status: res.status, body };
        const status = Number(res.status || 0);
        const retriable = [429, 500, 502, 503, 504].includes(status);
        const errMessage = toUserError(body, "Ошибка запроса");
        const code = body.code ? ` [${body.code}]` : "";
        lastErr = new Error(errMessage + code);
        if (!retriable || attempt >= retries) break;
        await new Promise((r) => setTimeout(r, 500 * (attempt + 1)));
      }
      throw lastErr || new Error("Ошибка сети");
    }

    async function uploadApi(path, { files = [], form = {}, retries = 0 } = {}) {
      const formData = new FormData();
      for (const file of files || []) formData.append("files", file);
      for (const [key, value] of Object.entries(form || {})) {
        if (value == null) continue;
        formData.append(key, String(value));
      }
      let lastErr = null;
      for (let attempt = 0; attempt <= retries; attempt += 1) {
        const res = await fetch(path, {
          method: "POST",
          headers: { ...authHeaders() },
          body: formData,
        });
        let body = {};
        let rawText = "";
        try {
          rawText = await res.text();
        } catch {}
        if (rawText) {
          try {
            body = JSON.parse(rawText);
          } catch {
            body = {};
          }
        }
        if (res.ok) return { status: res.status, body };
        if (Number(res.status || 0) === 413) {
          throw new Error("Файл слишком большой для текущих лимитов загрузки (413).");
        }
        const retriable = [429, 500, 502, 503, 504].includes(Number(res.status || 0));
        const fallback = rawText ? `Ошибка загрузки (${res.status})` : "Ошибка загрузки";
        lastErr = new Error(toUserError(body, fallback));
        if (!retriable || attempt >= retries) break;
        await new Promise((r) => setTimeout(r, 500 * (attempt + 1)));
      }
      throw lastErr || new Error("Ошибка загрузки");
    }

    async function withLoading(buttonId, action) {
      const btn = $(buttonId);
      if (!btn) return action();
      const original = btn.textContent;
      btn.disabled = true;
      btn.innerHTML = `${original}<span class="spinner"></span>`;
      try {
        return await action();
      } finally {
        btn.disabled = false;
        btn.textContent = original;
      }
    }

    function renderSession(extra = {}) {
      $("session-client").textContent = state.auth.client_id || "-";
      $("session-key").textContent = state.auth.api_key || "-";
      if (extra.balance != null) {
        $("session-balance").textContent = String(extra.balance);
      }
    }

    function shortId(value, max = 18) {
      const raw = String(value || "-");
      if (raw.length <= max) return raw;
      return `${raw.slice(0, Math.max(6, max - 3))}...`;
    }

    function setProgress(percent) {
      const safe = Math.max(0, Math.min(100, Number(percent) || 0));
      $("compute-progress-label").textContent = `${safe}%`;
      $("compute-progress-bar").style.width = `${safe}%`;
    }

    function setComputeTaskCard(task) {
      const validation = (task && typeof task.validation_policy === "object") ? task.validation_policy : {};
      const mode = validation.mode || "deterministic";
      const repl = Number(validation.replication_factor || 1);
      const quorum = Number(validation.quorum_threshold || repl || 1);
      $("compute-contract-value").textContent = task ? shortId(task.contract_id || "-") : "-";
      $("compute-job-value").textContent = task ? shortId(task.job_id || "-") : "-";
      $("compute-validation-mode").textContent = mode;
      $("compute-quorum").textContent = `${quorum}/${repl}`;
      $("compute-units").textContent = task ? String(task.work_units_required ?? "-") : "-";
      $("compute-type").textContent = task ? String(task.computation_type || "-") : "-";
      $("compute-step-status").textContent = task ? "Задача получена" : "Ожидание";
      setProgress(0);
    }

    function setComputeSubmitCard(body, statusCode = 200) {
      if (!body || typeof body !== "object") return;
      const reward = body.reward_issued != null ? `${body.reward_issued} ${body.reward_currency || ""}`.trim() : "-";
      $("compute-last-reward").textContent = reward;
      if (statusCode === 202 || body.status === "pending_validation") {
        $("compute-step-status").textContent = "Ожидание quorum-валидации";
        setProgress(100);
        return;
      }
      if (body.status === "success") {
        $("compute-step-status").textContent = body.challenge_window_open ? "Сдано (challenge-window)" : "Сдано и финализировано";
        setProgress(100);
      }
    }

    function renderJobsDashboard(payload) {
      const rows = Array.isArray(payload?.jobs) ? payload.jobs : [];
      const activeStatuses = new Set(["assigned", "in_progress", "completed_local"]);
      const doneStatuses = new Set(["submitted", "accepted", "completed", "finalized", "paid"]);
      const total = rows.length;
      const active = rows.filter((r) => activeStatuses.has(String(r.status || "").toLowerCase())).length;
      const pendingValidation = rows.filter((r) => String(r.status || "").toLowerCase() === "pending_validation").length;
      const finished = rows.filter((r) => doneStatuses.has(String(r.status || "").toLowerCase())).length;
      $("jobs-total").textContent = String(total);
      $("jobs-active").textContent = String(active);
      $("jobs-pending-validation").textContent = String(pendingValidation);
      $("jobs-finished").textContent = String(finished);
      const tbody = $("jobs-table-body");
      tbody.innerHTML = "";
      for (const row of rows.slice(0, 20)) {
        const status = String(row.status || "unknown");
        const progress = Number(row.progress_pct || 0);
        const tr = document.createElement("tr");
        tr.innerHTML = `<td class="mono-short" title="${row.job_id || ""}">${shortId(row.job_id || "-")}</td><td class="mono-short" title="${row.contract_id || ""}">${shortId(row.contract_id || "-")}</td><td>${status}</td><td>${Math.max(0, Math.min(100, progress))}%</td><td>${formatTs(row.updated_at)}</td>`;
        tbody.appendChild(tr);
      }
      if (!rows.length) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="5" class="muted">Пока нет задач для отображения.</td>`;
        tbody.appendChild(tr);
      }
    }

    function renderDevicesDashboard(payload) {
      const rows = Array.isArray(payload?.devices) ? payload.devices : [];
      const total = rows.length;
      const disabled = rows.filter((r) => Boolean(r.is_disabled)).length;
      const active = Math.max(0, total - disabled);
      $("devices-total").textContent = String(total);
      $("devices-active").textContent = String(active);
      $("devices-disabled").textContent = String(disabled);
      const tbody = $("devices-table-body");
      tbody.innerHTML = "";
      for (const row of rows.slice(0, 20)) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td class="mono-short" title="${row.device_id || ""}">${shortId(row.device_id || "-")}</td><td>${row.agent_version || "-"}</td><td>${row.is_disabled ? "disabled" : "active"}</td><td>${formatTs(row.last_heartbeat_at)}</td>`;
        tbody.appendChild(tr);
      }
      if (!rows.length) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="4" class="muted">Устройства не найдены.</td>`;
        tbody.appendChild(tr);
      }
    }

    function renderProfile(profile) {
      const safe = profile || {};
      $("profile-login").textContent = safe.login || "-";
      $("profile-nickname").textContent = safe.nickname || "-";
      $("profile-balance").textContent = String(safe.balance ?? 0);
      $("profile-fiat-est").textContent = String(safe.fiat_total_rub_estimate ?? 0);
      $("profile-submissions").textContent = String(safe.submissions_count ?? 0);
      $("profile-client-id").textContent = safe.client_id || "-";
      $("profile-fiat-wallet").textContent = formatWalletBalances(safe.fiat_wallet || {});
      renderSession({ balance: safe.balance });
    }

    function logCompute(text, level = "muted") {
      const line = document.createElement("p");
      line.className = `log-line ${level}`;
      line.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
      $("compute-log").prepend(line);
    }

    function buildWebDeviceCapabilities() {
      const cores = Number(navigator.hardwareConcurrency || 0);
      const hasGpu = !!window.WebGLRenderingContext;
      return {
        cpu_cores: Number.isFinite(cores) ? cores : 0,
        ram_gb: 0,
        has_gpu: hasGpu,
        supported_engines: ["python_compute"],
      };
    }

    function requireNonEmpty(value, title) {
      if (!String(value || "").trim()) throw new Error(`Заполните поле: ${title}`);
      return String(value).trim();
    }

    function requirePositiveInt(value, title) {
      const n = Number(value);
      if (!Number.isFinite(n) || n <= 0) throw new Error(`Поле "${title}" должно быть больше 0`);
      return Math.floor(n);
    }

    async function checkNode() {
      try {
        const { body } = await api("/health");
        $("node-status").textContent = `Узел: ${body.status}, протокол=${body.protocol_version}`;
        $("node-status").className = "status ok";
      } catch (e) {
        $("node-status").textContent = `Узел недоступен: ${e.message}`;
        $("node-status").className = "status err";
      }
    }

    function formatTs(ts) {
      if (ts == null) return "-";
      const n = Number(ts);
      if (!Number.isFinite(n) || n <= 0) return "-";
      return new Date(n * 1000).toLocaleString();
    }

    function formatWalletBalances(balances) {
      const safe = balances || {};
      return ["RUB", "USD", "EUR"].map((cur) => `${cur}: ${safe[cur] ?? 0}`).join(" · ");
    }

    const TX_TYPE_RU = {
      reward: "Награда",
      work_receipt: "Подтверждение работы",
      fiat_topup: "Пополнение",
      fiat_withdrawal_request: "Заявка на вывод",
      fiat_conversion: "Конвертация",
      contract_reward_settlement: "Выплата по контракту",
      contract_create_event: "Создание контракта",
      contract_budget_fund_event: "Пополнение бюджета контракта",
      contract_budget_refund_event: "Возврат бюджета контракта",
      contract_status_event: "Событие статуса контракта",
      contract_worker_escrow_hold: "Резерв эскроу",
      contract_worker_escrow_release: "Освобождение эскроу",
      contract_worker_escrow_penalty: "Штраф эскроу",
    };
    function txTypeToRussian(type) {
      return TX_TYPE_RU[type] || type || "—";
    }
    function txBadgeClass(type) {
      if (type === "reward" || type === "contract_reward_settlement") return "badge badge-reward";
      if (type === "work_receipt") return "badge badge-work-receipt";
      if (type === "fiat_conversion") return "badge badge-convert";
      if (type === "fiat_withdrawal_request") return "badge badge-withdraw";
      if (
        type === "contract_create_event" ||
        type === "contract_budget_fund_event" ||
        type === "contract_budget_refund_event" ||
        type === "contract_status_event"
      ) return "badge badge-contract";
      return "badge badge-default";
    }

    function txMatchesFilters(tx, { typeFilter, contractFilter }) {
      if (typeFilter && (tx.type || "") !== typeFilter) return false;
      if (contractFilter) {
        const contractId = (tx.contract_id || "").toString().toLowerCase();
        if (!contractId.includes(contractFilter.toLowerCase())) return false;
      }
      return true;
    }

    function humanCaseStatus(status) {
      const key = String(status || "").toLowerCase();
      if (key === "pending") return "ожидает";
      if (key === "in_review") return "на ручной проверке";
      if (key === "allow") return "разрешено";
      if (key === "review") return "нужна ручная проверка";
      if (key === "reject") return "отклонено";
      if (key === "queued") return "в очереди";
      if (key === "processing") return "в обработке";
      if (key === "retry") return "повтор";
      if (key === "completed") return "выполнено";
      if (key === "rejected") return "отклонено";
      if (key === "active") return "активно";
      if (key === "success") return "успешно";
      return key || "-";
    }

    function statusBadge(status) {
      const raw = String(status || "").toLowerCase();
      const text = humanCaseStatus(raw);
      let cls = "badge-status-muted";
      if (["allow", "completed", "active", "success"].includes(raw)) cls = "badge-status-ok";
      if (["pending", "in_review", "review", "queued", "processing", "retry"].includes(raw)) cls = "badge-status-warn";
      if (["reject", "rejected", "error", "failed", "blocked"].includes(raw)) cls = "badge-status-err";
      return `<span class="badge ${cls}">${text || "-"}</span>`;
    }

    function renderProviderCasesTable(payload) {
      const rows = Array.isArray(payload?.cases) ? payload.cases : (Array.isArray(payload) ? payload : []);
      const tbody = $("provider-cases-table-body");
      tbody.innerHTML = "";
      for (const row of rows.slice(0, 100)) {
        const amount = row.amount != null ? `${row.amount} ${row.currency || ""}`.trim() : "-";
        const tr = document.createElement("tr");
        tr.innerHTML = `<td class="mono-short" title="${row.case_id || ""}">${shortId(row.case_id || "-")}</td><td>${row.operation || "-"}</td><td>${amount}</td><td>${statusBadge(row.status)}</td><td>${statusBadge(row.decision)}</td><td>${formatTs(row.updated_at || row.created_at)}</td>`;
        tbody.appendChild(tr);
      }
      if (!rows.length) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="6" class="muted">Кейсы пока отсутствуют.</td>`;
        tbody.appendChild(tr);
      }
    }

    function renderProviderWebhooksTable(payload) {
      const rows = Array.isArray(payload?.events) ? payload.events : (Array.isArray(payload) ? payload : []);
      const tbody = $("provider-webhooks-table-body");
      tbody.innerHTML = "";
      for (const row of rows.slice(0, 100)) {
        const data = row.payload || row.data || {};
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${formatTs(row.created_at || row.ts || row.timestamp)}</td><td class="mono-short" title="${data.case_id || row.case_id || ""}">${shortId(data.case_id || row.case_id || "-")}</td><td>${row.event || data.event || "-"}</td><td>${statusBadge(data.decision || row.decision)}</td><td>${statusBadge(data.status || row.status)}</td>`;
        tbody.appendChild(tr);
      }
      if (!rows.length) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="5" class="muted">События пока отсутствуют.</td>`;
        tbody.appendChild(tr);
      }
    }

    function renderFxOraclesTable(payload) {
      const rows = Array.isArray(payload?.scores) ? payload.scores : [];
      const tbody = $("fx-oracles-table-body");
      tbody.innerHTML = "";
      for (const row of rows) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td class="mono-short">${row.oracle_id || "-"}</td><td>${row.score ?? "-"}</td><td>${row.penalties ?? "-"}</td>`;
        tbody.appendChild(tr);
      }
      if (!rows.length) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="3" class="muted">Нет данных по оракулам.</td>`;
        tbody.appendChild(tr);
      }
    }

    function renderPaymentsOpsTable(payload) {
      const rows = Array.isArray(payload?.operations) ? payload.operations : [];
      const tbody = $("payments-ops-table-body");
      tbody.innerHTML = "";
      for (const row of rows.slice(0, 30)) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td class="mono-short" title="${row.operation_id || ""}">${shortId(row.operation_id || "-")}</td><td>${row.amount || 0} ${row.currency || ""}</td><td>${statusBadge(row.status)}</td><td>${row.retries ?? 0}</td><td class="mono-short" title="${row.provider_ref || ""}">${shortId(row.provider_ref || "-")}</td><td>${formatTs(row.updated_at)}</td>`;
        tbody.appendChild(tr);
      }
      if (!rows.length) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="6" class="muted">Операции выплат отсутствуют.</td>`;
        tbody.appendChild(tr);
      }
    }

    function renderReconcileTable(payload) {
      const rows = Array.isArray(payload?.reports) ? payload.reports : (payload?.report_id ? [payload] : []);
      const tbody = $("payments-reconcile-table-body");
      tbody.innerHTML = "";
      for (const row of rows.slice(0, 20)) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td class="mono-short">${row.report_id || "-"}</td><td>${row.checked_operations ?? 0}</td><td>${row.mismatch_count ?? 0}</td><td>${formatTs(row.created_at)}</td>`;
        tbody.appendChild(tr);
      }
      if (!rows.length) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="4" class="muted">Сверки пока не запускались.</td>`;
        tbody.appendChild(tr);
      }
    }

    async function computePowProof(task) {
      const difficulty = Number(task?.difficulty || 1);
      const contractId = String(task?.contract_id || "");
      const taskName = String(task?.task_name || "");
      let nonce = 0;
      while (nonce < 6000000) {
        const input = `${contractId}|${taskName}|${nonce}`;
        const hash = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(input));
        const hex = Array.from(new Uint8Array(hash)).map((b) => b.toString(16).padStart(2, "0")).join("");
        if (hex.startsWith("0".repeat(Math.min(8, Math.max(1, difficulty))))) {
          return { nonce: String(nonce), result_data: `pow:${hex}`, work_units_done: Number(task.work_units_required || 1) };
        }
        nonce += 1;
        if (nonce % 25000 === 0) logCompute(`PoW попыток: ${nonce}`, "muted");
      }
      return { nonce: "0", result_data: "fallback-result", work_units_done: Number(task.work_units_required || 1) };
    }

    async function refreshProviderData() {
      const [sectors, contracts] = await Promise.all([
        api("/provider/sectors"),
        api("/provider/contracts"),
      ]);
      $("sectors-json").textContent = pp(sectors.body);
      $("provider-contracts-json").textContent = pp(contracts.body);
      const rows = Array.isArray(sectors.body) ? sectors.body : [];
      const select = $("contract-sector");
      select.innerHTML = "";
      for (const row of rows) {
        const o = document.createElement("option");
        o.value = row.sector_id;
        o.textContent = `${row.sector_name} (${row.sector_id})`;
        select.appendChild(o);
      }
      const contractRows = Array.isArray(contracts.body) ? contracts.body : [];
      const manageSelect = $("manage-contract-id");
      const ingestionSelect = $("ingestion-contract-id");
      const workerSelect = $("worker-run-contract");
      manageSelect.innerHTML = "";
      ingestionSelect.innerHTML = "";
      workerSelect.innerHTML = "";
      for (const row of contractRows) {
        const o = document.createElement("option");
        o.value = row.contract_id;
        o.textContent = `${row.contract_id} [${row.status || "неизвестно"}]`;
        manageSelect.appendChild(o);
        const io = document.createElement("option");
        io.value = row.contract_id;
        io.textContent = `${row.contract_id} [${row.status || "неизвестно"}]`;
        ingestionSelect.appendChild(io);
        const w = document.createElement("option");
        w.value = row.contract_id;
        w.textContent = `${row.contract_id} [${row.status || "неизвестно"}]`;
        workerSelect.appendChild(w);
      }
    }

    async function refreshWallet() {
      const { body } = await api("/market/wallet");
      const balances = body.balances || {};
      const parts = ["RUB", "USD", "EUR"].map((c) => `${c} ${balances[c] ?? 0}`);
      $("wallet-status").textContent = "Баланс: " + parts.join(", ");
      $("wallet-json").textContent = pp(body);
    }

    async function refreshGovernance() {
      const { body } = await api("/network/governance/info");
      $("gov-json").textContent = pp(body);
      const governance = body.governance || {};
      const admittedNodes = Array.isArray(governance.admitted_nodes) ? governance.admitted_nodes.length : 0;
      const admittedValidators = Array.isArray(governance.admitted_validators)
        ? governance.admitted_validators.length
        : 0;
      const rollout = governance.protocol_rollout || {};
      $("gov-protocol-version").textContent = String(body.protocol_version || "-");
      $("gov-nodes-count").textContent = String(admittedNodes);
      $("gov-validators-count").textContent = String(admittedValidators);
      $("gov-rollout-status").textContent = String(rollout.status || "нет активного обновления");
      const versions = Array.isArray(body.supported_protocol_versions) ? body.supported_protocol_versions : [];
      const versionSelect = $("gov-rollout-version");
      const currentValue = versionSelect.value;
      versionSelect.innerHTML = "";
      for (const version of versions) {
        const o = document.createElement("option");
        o.value = version;
        o.textContent = version;
        versionSelect.appendChild(o);
      }
      if (currentValue && versions.includes(currentValue)) {
        versionSelect.value = currentValue;
      }
      $("gov-rollout-required-acks").value = String(Math.max(1, admittedNodes || 1));
    }

    async function refreshProviderCases() {
      const status = $("provider-cases-status").value;
      const query = status ? `?status=${encodeURIComponent(status)}&limit=100` : "?limit=100";
      const { body } = await api(`/compliance/provider/cases${query}`);
      $("provider-cases-json").textContent = pp(body);
      renderProviderCasesTable(body);
    }

    async function refreshProviderWebhooks() {
      const { body } = await api("/compliance/provider/webhooks?limit=100");
      $("provider-webhooks-json").textContent = pp(body);
      renderProviderWebhooksTable(body);
    }

    async function refreshFxOracles() {
      const { body } = await api("/market/fx/oracles");
      $("fx-oracles-json").textContent = pp(body);
      renderFxOraclesTable(body);
    }

    async function refreshFxEpoch() {
      const { body } = await api("/market/rates");
      const epochId = (body.latest_oracle_epoch || {}).epoch_id;
      if (epochId) {
        const epoch = await api(`/market/fx/epoch/${encodeURIComponent(epochId)}`);
        $("fx-epoch-json").textContent = pp(epoch.body);
        $("fx-confidence").textContent = String(
          (epoch.body.finalization || {}).meta?.confidence ?? epoch.body.confidence_preview ?? "-"
        );
        $("fx-volatility").textContent = String(
          (epoch.body.finalization || {}).meta?.volatility_score ?? epoch.body.volatility_score_preview ?? "-"
        );
      } else {
        $("fx-confidence").textContent = "-";
        $("fx-volatility").textContent = "-";
      }
      const rates = body.rates_to_rub || {};
      $("fx-rate-usd").textContent = String(rates.USD ?? "-");
      $("fx-rate-eur").textContent = String(rates.EUR ?? "-");
    }

    async function refreshTreasury() {
      const { body } = await api("/market/treasury/status");
      $("treasury-json").textContent = pp(body);
      const reserves = (body.treasury || {}).reserves || {};
      const buffer = (body.treasury || {}).reserve_buffer || {};
      $("treasury-rub").textContent = String(reserves.RUB ?? 0);
      $("treasury-usd").textContent = String(reserves.USD ?? 0);
      $("treasury-eur").textContent = String(reserves.EUR ?? 0);
      $("treasury-buffer-rub").textContent = String(buffer.RUB ?? "-");
    }

    async function refreshPaymentsOps() {
      const { body } = await api("/market/payments/operations?limit=50");
      renderPaymentsOpsTable(body);
    }

    async function refreshReconcileReports() {
      const { body } = await api("/market/payments/reconcile?limit=20");
      renderReconcileTable(body);
    }

    async function refreshWorkerProgress() {
      const { body } = await api("/worker_progress");
      $("worker-progress-json").textContent = pp(body);
    }

    async function refreshMyDevices() {
      const { body } = await api("/agent/devices/my");
      $("devices-json").textContent = pp(body);
      renderDevicesDashboard(body);
    }

    async function refreshMyJobs() {
      const { body } = await api("/jobs/my");
      $("jobs-json").textContent = pp(body);
      renderJobsDashboard(body);
    }

    async function refreshMarketJobs() {
      const { body } = await api("/market/jobs/available");
      const jobs = Array.isArray(body.jobs) ? body.jobs : [];
      const tbody = $("market-jobs-tbody");
      const emptyEl = $("market-jobs-empty");
      tbody.innerHTML = "";
      if (!jobs.length) {
        emptyEl.style.display = "block";
        return;
      }
      emptyEl.style.display = "none";
      for (const job of jobs) {
        const tr = document.createElement("tr");
        const contractId = job.contract_id || "-";
        const sector = job.sector_name || job.sector_id || "-";
        const reward = `${job.reward_per_task ?? 0} ${job.reward_currency || "RUB"}`;
        const workUnits = String(job.work_units ?? 0);
        const compType = job.computation_type || "simple_pow";
        const btn = document.createElement("button");
        btn.textContent = "Взять";
        btn.className = "primary";
        btn.onclick = () => takeJobFromMarket(contractId);
        tr.innerHTML = `<td class="mono">${contractId}</td><td>${sector}</td><td>${reward}</td><td>${workUnits}</td><td>${compType}</td><td></td>`;
        tr.lastElementChild.appendChild(btn);
        tbody.appendChild(tr);
      }
    }

    async function takeJobFromMarket(contractId) {
      try {
        const payload = {
          contract_id: contractId,
          scheduler_profile: "adaptive",
          device_capabilities: buildWebDeviceCapabilities(),
        };
        const { body } = await api("/agent/get_task", { method: "POST", payload });
        state.task = body;
        $("task-json").textContent = pp(body);
        setComputeTaskCard(body);
        $("compute-contract-id").value = contractId;
        document.querySelectorAll(".tab-btn").forEach((el) => el.classList.remove("active"));
        document.querySelectorAll(".tab").forEach((el) => el.classList.remove("active"));
        $("tab-compute").classList.add("active");
        document.querySelector('.tab-btn[data-tab="tab-compute"]').classList.add("active");
        showToast("Задача получена. Перейдите на вкладку «Вычисления».", "ok");
      } catch (e) {
        showToast("Ошибка: " + e.message, "err");
      }
    }

    async function refreshProfile() {
      const { body } = await api("/me");
      renderProfile(body);
      return body;
    }

    function logoutUser() {
      state.auth = { api_key: "", client_id: "" };
      saveAuth();
      renderSession({ balance: "-" });
      renderProfile({});
      renderJobsDashboard({ jobs: [] });
      renderDevicesDashboard({ devices: [] });
      state.task = null;
      setComputeTaskCard(null);
      $("task-json").textContent = "-";
      $("submit-json").textContent = "-";
      setHumanStatus("Сессия очищена. Войдите в аккаунт.", "muted");
      showToast("Вы вышли из аккаунта.", "ok");
    }

    async function refreshIngestionDetails() {
      const contractId = $("ingestion-contract-id").value;
      if (!contractId) {
        $("ingestion-json").textContent = "Выберите контракт";
        return;
      }
      const { body } = await api(`/provider/contracts/${encodeURIComponent(contractId)}/ingestion`);
      $("ingestion-json").textContent = pp(body);
    }

    async function refreshExplorerSummary() {
      const [metricsRes, chainRes] = await Promise.all([api("/metrics"), api("/chain")]);
      const metrics = metricsRes.body || {};
      const chain = Array.isArray(chainRes.body) ? chainRes.body : [];
      $("ex-chain-len").textContent = String(metrics.chain_length ?? chain.length ?? 0);
      $("ex-last-index").textContent = chain.length ? String(chain[chain.length - 1].index) : "-";
      $("ex-pending").textContent = String(metrics.pending_transactions ?? 0);
      const tbody = $("ex-blocks-table-body");
      tbody.innerHTML = "";
      for (const block of chain.slice(-50).reverse()) {
        const tr = document.createElement("tr");
        tr.className = "clickable";
        const hash = String(block.hash || "");
        tr.innerHTML = `<td>${block.index ?? "-"}</td><td class="mono" title="${hash}">${hash ? hash.slice(0, 16) + "..." : "-"}</td><td>${Array.isArray(block.transactions) ? block.transactions.length : 0}</td><td>${formatTs(block.timestamp)}</td>`;
        tr.onclick = () => showExplorerBlock(block.index);
        tbody.appendChild(tr);
      }
    }

    function renderExplorerBlockTransactions() {
      const block = state.explorer.currentBlock;
      if (!block) return;
      const typeFilter = $("ex-detail-filter-type").value;
      const contractFilter = $("ex-detail-filter-contract").value.trim();
      const allTx = Array.isArray(block.transactions) ? block.transactions : [];
      const filtered = allTx.filter((tx) => txMatchesFilters(tx || {}, { typeFilter, contractFilter }));
      $("ex-detail-tx-count").textContent = `${filtered.length} / ${allTx.length}`;
      const tbody = $("ex-detail-tx-body");
      tbody.innerHTML = "";
      for (const tx of filtered) {
        const type = tx.type || "";
        const typeRu = txTypeToRussian(type);
        const from = (tx.from || tx.client_id || "-").toString().slice(0, 20);
        const to = (tx.to || "-").toString().slice(0, 20);
        const amount = tx.amount != null ? tx.amount : (tx.fee != null ? `-${tx.fee}` : "-");
        const contract = tx.contract_id || "-";
        const work = tx.work_units != null ? tx.work_units : "-";
        const tr = document.createElement("tr");
        tr.innerHTML = `<td><span class="${txBadgeClass(type)}">${typeRu}</span></td><td class="mono">${from}</td><td class="mono">${to}</td><td>${amount}</td><td class="mono">${contract}</td><td>${work}</td>`;
        tbody.appendChild(tr);
      }
    }

    async function showExplorerBlock(index) {
      const { body } = await api(`/explorer/block/${encodeURIComponent(index)}`);
      state.explorer.currentBlock = body;
      $("ex-block-detail").classList.add("active");
      $("ex-detail-index").textContent = String(body.index ?? "-");
      $("ex-detail-hash").textContent = String(body.hash || "-");
      $("ex-detail-prev").textContent = String(body.previous_hash || "-");
      $("ex-detail-time").textContent = formatTs(body.timestamp);
      renderExplorerBlockTransactions();
    }

    function renderExplorerAddressTransactions() {
      const payload = state.explorer.currentAddressPayload;
      if (!payload) return;
      const typeFilter = $("ex-address-filter-type").value;
      const contractFilter = $("ex-address-filter-contract").value.trim();
      const allRows = Array.isArray(payload.transactions) ? payload.transactions : [];
      const filtered = allRows.filter(({ tx }) => txMatchesFilters(tx || {}, { typeFilter, contractFilter }));
      $("ex-addr-tx-count").textContent = `${filtered.length} / ${allRows.length}`;
      const tbody = $("ex-address-tx-body");
      tbody.innerHTML = "";
      for (const { block_index, tx } of filtered) {
        const tr = document.createElement("tr");
        let details = "";
        if (tx.type === "reward") details = `Награда +${tx.amount ?? 0} за ${tx.contract_id || ""}`;
        if (tx.type === "work_receipt") details = `Работа: ${tx.contract_id || ""}, ед. ${tx.work_units ?? 0}, комиссия ${tx.fee ?? 0}`;
        if (tx.type === "fiat_topup") details = `Пополнение: +${tx.amount ?? 0} ${tx.currency || ""}`;
        if (tx.type === "fiat_withdrawal_request") details = `Вывод: ${tx.amount ?? 0} ${tx.currency || ""}, статус ${tx.status || "queued"}`;
        if (tx.type === "fiat_conversion") details = `Конвертация: ${tx.source_amount ?? 0} ${tx.from_currency || ""} -> ${tx.target_amount ?? 0} ${tx.to_currency || ""}`;
        if (tx.type === "contract_reward_settlement") details = `Выплата за контракт: +${tx.amount ?? 0} ${tx.currency || ""}, контракт ${tx.contract_id || ""}, ед. ${tx.work_units ?? 0}`;
        if (tx.type === "contract_create_event") details = `Создан контракт: ${tx.contract_id || ""} (${tx.task_name || ""})`;
        if (tx.type === "contract_budget_fund_event") details = `Пополнение бюджета контракта: +${tx.amount ?? 0} ${tx.currency || ""}`;
        if (tx.type === "contract_budget_refund_event") details = `Возврат бюджета контракта: +${tx.amount ?? 0} ${tx.currency || ""}`;
        if (tx.type === "contract_status_event") details = `Статус контракта: ${tx.status || ""}`;
        if (!details) details = `tx_id: ${String(tx.event_id || tx.id || "n/a").slice(0, 24)}`;
        tr.innerHTML = `<td><a href="#" class="mono ex-block-link" data-index="${block_index}">${block_index}</a></td><td><span class="${txBadgeClass(tx.type || "")}">${txTypeToRussian(tx.type || "")}</span></td><td>${details}</td>`;
        tbody.appendChild(tr);
      }
      document.querySelectorAll(".ex-block-link").forEach((el) => {
        el.onclick = (e) => {
          e.preventDefault();
          const idx = Number(el.getAttribute("data-index"));
          if (Number.isFinite(idx)) showExplorerBlock(idx);
        };
      });
    }

    async function showExplorerAddress(clientId) {
      const { body } = await api(`/explorer/address/${encodeURIComponent(clientId)}`);
      state.explorer.currentAddressPayload = body;
      $("ex-address-detail").classList.add("active");
      if (body.resolved_from) {
        $("ex-address-msg").textContent = `Префикс ${body.resolved_from} распознан как ${body.client_id}`;
        $("ex-address-msg").className = "small ok";
        $("ex-address-msg").style.display = "inline";
      } else {
        $("ex-address-msg").style.display = "none";
      }
      $("ex-addr-client-id").textContent = String(body.client_id || "-");
      $("ex-addr-fiat-wallet").textContent = formatWalletBalances(body.fiat_wallet || {});
      $("ex-addr-fiat-rub-estimate").textContent = String(body.fiat_total_rub_estimate ?? 0);
      $("ex-addr-chain-points").textContent = String(body.chain_points ?? body.balance ?? 0);
      renderExplorerAddressTransactions();
    }

    async function initTaskClasses() {
      const { body } = await api("/provider/task-classes");
      const select = $("contract-task-class");
      for (const row of body.task_classes || []) {
        const o = document.createElement("option");
        o.value = row.task_class;
        o.textContent = `${row.task_class} (${row.validation_style})`;
        select.appendChild(o);
      }
    }

    async function initWorkloadPresets() {
      const { body } = await api("/provider/workload-presets");
      const select = $("contract-workload-preset");
      const current = select.value;
      select.innerHTML = '<option value="">без пресета</option>';
      for (const row of body.workload_presets || []) {
        const o = document.createElement("option");
        o.value = row.preset_id;
        o.textContent = `${row.title || row.preset_id} (${row.preset_id})`;
        select.appendChild(o);
      }
      if (current && Array.from(select.options).some((opt) => opt.value === current)) {
        select.value = current;
      }
    }

    function initComputationTypes() {
      const known = [
        "simple_pow", "cosmological", "supernova", "mhd",
        "radiative", "gravitational_waves", "molecular_dynamics_benchpep",
      ];
      const select = $("contract-compute-type");
      for (const item of known) {
        const o = document.createElement("option");
        o.value = item;
        o.textContent = item;
        select.appendChild(o);
      }
    }

    const TAB_REFRESH_MAP = {
      "tab-profile": [refreshProfile, refreshMyJobs, refreshMyDevices],
      "tab-compute": [refreshWorkerProgress, refreshMyJobs],
      "tab-market-jobs": [refreshMarketJobs],
      "tab-provider": [refreshProviderData],
      "tab-market": [refreshWallet, refreshTreasury, refreshFxOracles, refreshFxEpoch, refreshPaymentsOps, refreshReconcileReports],
      "tab-governance": [refreshGovernance],
      "tab-explorer": [refreshExplorerSummary],
    };
    async function refreshForTab(tab) {
      const fns = TAB_REFRESH_MAP[tab];
      if (!fns) return;
      const hasAuth = !!(state.auth?.api_key);
      if (tab !== "tab-explorer" && !hasAuth) return;
      for (const fn of fns) {
        try { await fn(); } catch (e) { /* ignore */ }
      }
    }
    function setupTabs() {
      const buttons = Array.from(document.querySelectorAll(".tab-btn[data-tab]"));
      buttons.forEach((btn) => {
        btn.onclick = async () => {
          const tab = btn.getAttribute("data-tab");
          document.querySelectorAll(".tab-btn").forEach((el) => el.classList.remove("active"));
          document.querySelectorAll(".tab").forEach((el) => el.classList.remove("active"));
          btn.classList.add("active");
          $(tab).classList.add("active");
          await refreshForTab(tab);
        };
      });
    }

    $("btn-expert-mode").onclick = () => {
      state.ui.expert_mode = !Boolean(state.ui?.expert_mode);
      saveUiPrefs();
      applyExpertMode();
    };

    $("btn-login").onclick = async () => {
      try {
        const { body } = await api("/auth/login", {
          method: "POST",
          payload: { login: $("login-name").value.trim(), password: $("login-pass").value },
        });
        state.auth.client_id = body.client_id;
        state.auth.api_key = body.api_key;
        saveAuth();
        renderProfile(body);
        try {
          await initTaskClasses();
          await initWorkloadPresets();
          await refreshProviderData();
          await refreshWallet();
          await refreshTreasury();
          await refreshGovernance();
          await refreshProfile();
          await refreshFxOracles();
          await refreshFxEpoch();
          await refreshPaymentsOps();
          await refreshReconcileReports();
          await refreshProviderCases();
          await refreshProviderWebhooks();
          await refreshWorkerProgress();
          await refreshMyDevices();
          await refreshMyJobs();
          const claims = await api("/demo/claims");
          $("claims-json").textContent = pp(claims.body);
          const script = await api("/demo/script");
          $("demo-script-json").textContent = pp(script.body);
        } catch {}
      } catch (e) {
        alert(e.message);
      }
    };

    $("btn-register").onclick = async () => {
      try {
        const { body } = await api("/auth/register", {
          method: "POST",
          payload: {
            login: $("reg-name").value.trim(),
            password: $("reg-pass").value,
            nickname: $("reg-nick").value.trim(),
          },
        });
        state.auth.client_id = body.client_id;
        state.auth.api_key = body.api_key;
        saveAuth();
        renderProfile(body);
        try {
          await initTaskClasses();
          await initWorkloadPresets();
          await refreshProviderData();
          await refreshWallet();
          await refreshTreasury();
          await refreshGovernance();
          await refreshProfile();
          await refreshFxOracles();
          await refreshFxEpoch();
          await refreshPaymentsOps();
          await refreshReconcileReports();
          await refreshProviderCases();
          await refreshProviderWebhooks();
          await refreshWorkerProgress();
          await refreshMyDevices();
          await refreshMyJobs();
          const claims = await api("/demo/claims");
          $("claims-json").textContent = pp(claims.body);
          const script = await api("/demo/script");
          $("demo-script-json").textContent = pp(script.body);
        } catch {}
      } catch (e) {
        alert(e.message);
      }
    };

    $("btn-me").onclick = async () => {
      try {
        await refreshProfile();
      } catch (e) {
        alert(e.message);
      }
    };

    $("btn-logout").onclick = () => logoutUser();
    $("btn-profile-logout").onclick = () => logoutUser();

    $("btn-profile-refresh").onclick = async () => {
      try {
        await refreshProfile();
        await refreshMyJobs();
        await refreshMyDevices();
      } catch (e) {
        alert(e.message);
      }
    };

    $("btn-download-desktop-agent").onclick = () => {
      window.open("/download/desktop-agent", "_blank");
    };

    $("btn-get-task").onclick = async () => {
      await withLoading("btn-get-task", async () => {
      try {
        const payload = {
          contract_id: $("compute-contract-id").value.trim() || undefined,
          sector_id: $("compute-sector-id").value.trim() || undefined,
          scheduler_profile: $("compute-scheduler-profile").value || "adaptive",
          device_capabilities: buildWebDeviceCapabilities(),
        };
        const { body } = await api("/agent/get_task", { method: "POST", payload });
        state.task = body;
        $("task-json").textContent = pp(body);
        setComputeTaskCard(body);
        logCompute(`Задача получена: ${body.job_id || "n/a"} (${body.computation_type || "неизвестно"})`, "ok");
        setHumanStatus(
          `Задача получена. ID задачи: ${body.job_id || "-"}, режим проверки: ${((body.validation_policy || {}).mode) || "deterministic"}.`,
          "ok"
        );
        showToast("Задача выдана успешно.", "ok");
      } catch (e) {
        logCompute(`Ошибка получения задачи: ${e.message}`, "err");
        setHumanStatus(`Не удалось получить задачу: ${e.message}`, "err");
      }
      });
    };

    $("btn-compute-submit").onclick = async () => {
      await withLoading("btn-compute-submit", async () => {
      if (!state.task) {
        logCompute("Задача не загружена. Сначала нажми 'Взять задачу'.", "warn");
        setHumanStatus("Сначала получите задачу, затем отправляйте результат.", "warn");
        return;
      }
      try {
        const computed = await computePowProof(state.task);
        await api(`/agent/job/${encodeURIComponent(state.task.job_id)}/complete_ack`, {
          method: "POST",
          payload: { result_data: computed.result_data, nonce: computed.nonce },
        });
        const payload = {
          client_id: state.auth.client_id,
          contract_id: state.task.contract_id,
          job_id: state.task.job_id,
          attempt_id: 1,
          work_units_done: computed.work_units_done,
          result_data: computed.result_data,
          nonce: computed.nonce,
          output_artifacts: [],
        };
        const { status, body } = await api("/submit_work", { method: "POST", payload, retries: 2 });
        $("submit-json").textContent = pp(body);
        setComputeSubmitCard(body, status);
        $("challenge-job-id").value = state.task.job_id || "";
        if (status === 202 || body.status === "pending_validation") {
          const replication = body.replication || {};
          logCompute(
            `Ожидание quorum-валидации: ${replication.received_submissions || 0}/${replication.required_submissions || "?"}`,
            "warn"
          );
          setHumanStatus(
            `Результат принят. Ожидаем кворум: ${replication.received_submissions || 0}/${replication.required_submissions || "?"}.`,
            "warn"
          );
          showToast("Результат принят, ожидается кворум.", "warn");
          return;
        }
        if (body.challenge_window_open) {
          logCompute("Сабмит принят. Окно challenge открыто.", "warn");
          setHumanStatus("Результат засчитан. Сейчас открыто окно challenge.", "warn");
        } else {
          logCompute("Сабмит принят и финализирован.", "ok");
          setHumanStatus("Результат засчитан и финализирован.", "ok");
        }
        showToast("Результат успешно отправлен.", "ok");
        await refreshProfile();
        await refreshMyJobs();
      } catch (e) {
        logCompute(`Ошибка сабмита: ${e.message}`, "err");
        setHumanStatus(`Ошибка отправки: ${e.message}`, "err");
      }
      });
    };

    $("btn-open-challenge").onclick = async () => {
      try {
        const jobId = $("challenge-job-id").value.trim();
        const { body } = await api(`/job/${encodeURIComponent(jobId)}/challenge`, {
          method: "POST",
          payload: { reason: $("challenge-reason").value.trim() || "manual_challenge" },
        });
        $("challenge-json").textContent = pp(body);
        if (body.challenge && body.challenge.challenge_id) {
          $("challenge-id").value = body.challenge.challenge_id;
        }
        if (body.dispute && body.dispute.dispute_id) {
          $("dispute-id").value = body.dispute.dispute_id;
        }
      } catch (e) {
        $("challenge-json").textContent = e.message;
      }
    };

    $("btn-finalize-challenge-window").onclick = async () => {
      try {
        const jobId = $("challenge-job-id").value.trim();
        const { body } = await api(`/job/${encodeURIComponent(jobId)}/challenge/finalize`, {
          method: "POST",
          payload: {},
        });
        $("challenge-json").textContent = pp(body);
      } catch (e) {
        $("challenge-json").textContent = e.message;
      }
    };

    $("btn-resolve-challenge").onclick = async () => {
      try {
        const challengeId = $("challenge-id").value.trim();
        const { body } = await api(`/challenges/${encodeURIComponent(challengeId)}/resolve`, {
          method: "POST",
          payload: { decision: $("challenge-decision").value },
        });
        $("challenge-resolve-json").textContent = pp(body);
        if (body.dispute_id) {
          $("dispute-id").value = body.dispute_id;
        }
      } catch (e) {
        $("challenge-resolve-json").textContent = e.message;
      }
    };

    $("btn-dispute-get").onclick = async () => {
      try {
        const disputeId = $("dispute-id").value.trim();
        const { body } = await api(`/disputes/${encodeURIComponent(disputeId)}`);
        $("dispute-json").textContent = pp(body);
        const d = body.dispute || body;
        if (d && d.dispute_id) {
          setHumanStatus(
            `Dispute ${d.dispute_id}: статус ${d.status || "unknown"}, дедлайн review ${formatTs(d.review_deadline_at)}.`,
            "warn"
          );
        }
      } catch (e) {
        $("dispute-json").textContent = e.message;
      }
    };

    $("btn-dispute-event").onclick = async () => {
      try {
        const disputeId = $("dispute-id").value.trim();
        let payload = {};
        const raw = $("dispute-payload-json").value.trim();
        if (raw) payload = JSON.parse(raw);
        const { body } = await api(`/disputes/${encodeURIComponent(disputeId)}/event`, {
          method: "POST",
          payload: {
            event: $("dispute-event").value.trim(),
            payload,
          },
        });
        $("dispute-json").textContent = pp(body);
      } catch (e) {
        $("dispute-json").textContent = e.message;
      }
    };

    $("btn-run-worker").onclick = async () => {
      try {
        const manual = $("worker-run-manual-contract").value.trim();
        const selected = $("worker-run-contract").value;
        const contractId = manual || selected;
        if (!contractId) throw new Error("Выберите контракт или введите ID контракта");
        const { body } = await api("/run_worker", {
          method: "POST",
          payload: {
            contract_id: contractId,
            run_once: $("worker-run-once").checked,
          },
        });
        $("run-worker-json").textContent = pp(body);
      } catch (e) {
        $("run-worker-json").textContent = e.message;
      }
    };

    $("btn-worker-progress-refresh").onclick = async () => {
      try {
        await refreshWorkerProgress();
      } catch (e) {
        $("worker-progress-json").textContent = e.message;
      }
    };

    $("btn-devices-refresh").onclick = async () => {
      try {
        await refreshMyDevices();
      } catch (e) {
        $("devices-json").textContent = e.message;
      }
    };

    $("btn-jobs-refresh").onclick = async () => {
      try {
        await refreshMyJobs();
      } catch (e) {
        $("jobs-json").textContent = e.message;
      }
    };

    $("btn-provider-cases-refresh").onclick = async () => {
      try {
        await refreshProviderCases();
      } catch (e) {
        $("provider-cases-json").textContent = e.message;
      }
    };

    $("provider-cases-status").onchange = async () => {
      try {
        await refreshProviderCases();
      } catch (e) {
        $("provider-cases-json").textContent = e.message;
      }
    };

    $("btn-provider-webhooks-refresh").onclick = async () => {
      try {
        await refreshProviderWebhooks();
      } catch (e) {
        $("provider-webhooks-json").textContent = e.message;
      }
    };

    $("btn-provider-webhooks-dispatch").onclick = async () => {
      try {
        const { body } = await api("/compliance/provider/webhooks", { method: "POST", payload: {} });
        $("provider-webhooks-json").textContent = pp(body);
        await refreshProviderWebhooks();
      } catch (e) {
        $("provider-webhooks-json").textContent = e.message;
      }
    };

    $("btn-fx-oracles-refresh").onclick = async () => {
      try {
        await refreshFxOracles();
      } catch (e) {
        $("fx-oracles-json").textContent = e.message;
      }
    };

    $("btn-fx-epoch-refresh").onclick = async () => {
      try {
        await refreshFxEpoch();
      } catch (e) {
        $("fx-epoch-json").textContent = e.message;
      }
    };

    $("btn-fx-finalize").onclick = async () => {
      try {
        const { body } = await api("/market/fx/finalize", { method: "POST", payload: {} });
        $("fx-epoch-json").textContent = pp(body);
        await refreshFxOracles();
        await refreshFxEpoch();
        showToast("Эпоха FX финализирована.", "ok");
      } catch (e) {
        $("fx-epoch-json").textContent = e.message;
      }
    };

    $("btn-treasury-refresh").onclick = async () => {
      try {
        await refreshTreasury();
        await refreshPaymentsOps();
      } catch (e) {
        $("treasury-json").textContent = e.message;
      }
    };

    $("btn-payments-dispatch").onclick = async () => {
      try {
        const { body } = await api("/market/payments/dispatch", { method: "POST", payload: { max_batch: 30 } });
        $("payments-dispatch-json").textContent = pp(body);
        await refreshPaymentsOps();
        showToast("Диспетчер выплат выполнен.", "ok");
      } catch (e) {
        $("payments-dispatch-json").textContent = e.message;
      }
    };

    $("btn-payments-reconcile").onclick = async () => {
      try {
        const { body } = await api("/market/payments/reconcile", { method: "POST", payload: {} });
        renderReconcileTable(body);
        $("payments-dispatch-json").textContent = pp(body);
        showToast("Сверка выполнена.", "ok");
      } catch (e) {
        $("payments-dispatch-json").textContent = e.message;
      }
    };

    $("btn-explorer-refresh").onclick = async () => {
      try {
        await refreshExplorerSummary();
      } catch (e) {
        $("ex-block-search-msg").textContent = e.message;
        $("ex-block-search-msg").style.display = "inline";
      }
    };

    $("btn-ex-search-block").onclick = async () => {
      try {
        $("ex-block-search-msg").style.display = "none";
        const idx = Number($("ex-search-block-index").value);
        if (!Number.isFinite(idx) || idx < 0) throw new Error("Введите корректный индекс блока");
        await showExplorerBlock(idx);
      } catch (e) {
        $("ex-block-search-msg").textContent = e.message;
        $("ex-block-search-msg").style.display = "inline";
      }
    };

    $("btn-ex-search-address").onclick = async () => {
      try {
        $("ex-address-msg").style.display = "none";
        const clientId = $("ex-search-address").value.trim();
        if (!clientId) throw new Error("Введите ID пользователя");
        await showExplorerAddress(clientId);
      } catch (e) {
        $("ex-address-msg").textContent = e.message;
        $("ex-address-msg").className = "small err";
        $("ex-address-msg").style.display = "inline";
      }
    };

    $("btn-ex-paste-address").onclick = async () => {
      try {
        const text = await navigator.clipboard.readText();
        if (text) $("ex-search-address").value = text.trim();
      } catch {}
    };

    $("btn-ex-paste-block-index").onclick = async () => {
      try {
        const text = await navigator.clipboard.readText();
        if (text) $("ex-search-block-index").value = text.trim();
      } catch {}
    };

    $("ex-search-address").onkeydown = (e) => {
      if (e.key === "Enter") $("btn-ex-search-address").click();
    };

    $("ex-search-block-index").onkeydown = (e) => {
      if (e.key === "Enter") $("btn-ex-search-block").click();
    };

    $("ex-detail-filter-type").onchange = renderExplorerBlockTransactions;
    $("ex-detail-filter-contract").oninput = renderExplorerBlockTransactions;
    $("btn-ex-detail-filter-clear").onclick = () => {
      $("ex-detail-filter-type").value = "";
      $("ex-detail-filter-contract").value = "";
      renderExplorerBlockTransactions();
    };

    $("ex-address-filter-type").onchange = renderExplorerAddressTransactions;
    $("ex-address-filter-contract").oninput = renderExplorerAddressTransactions;
    $("btn-ex-address-filter-clear").onclick = () => {
      $("ex-address-filter-type").value = "";
      $("ex-address-filter-contract").value = "";
      renderExplorerAddressTransactions();
    };

    $("btn-sector-create").onclick = async () => {
      try {
        await api("/provider/sectors", {
          method: "POST",
          payload: {
            sector_name: $("sector-name").value.trim(),
            organization_name: $("sector-org").value.trim(),
            compute_domain: $("sector-domain").value.trim(),
            description: $("sector-desc").value.trim(),
          },
        });
        await refreshProviderData();
      } catch (e) {
        alert(e.message);
      }
    };

    $("btn-contract-create").onclick = async () => {
      try {
        const sectorId = requireNonEmpty($("contract-sector").value, "Сектор");
        const taskName = requireNonEmpty($("contract-name").value, "Название задачи");
        const payload = {
          sector_id: sectorId,
          task_name: taskName,
          task_description: $("contract-desc").value.trim(),
          task_category: $("contract-category").value.trim() || "Пользовательская",
          computation_type: $("contract-compute-type").value,
          task_class: $("contract-task-class").value || null,
          workload_preset_id: $("contract-workload-preset").value || null,
          work_units_required: requirePositiveInt($("contract-units").value, "Единиц на задачу"),
          reward_per_task: requirePositiveInt($("contract-reward").value, "Награда"),
          target_total_work_units: requirePositiveInt($("contract-target").value, "Целевой объем работ"),
          difficulty: requirePositiveInt($("contract-difficulty").value, "Сложность"),
          initial_budget_tokens: Math.max(0, Number($("contract-budget").value) || 0),
          budget_currency: $("contract-currency").value,
          activate_now: $("contract-activate-now").checked,
          benchmark_meta: {},
        };
        const { body } = await api("/provider/contracts", { method: "POST", payload });
        $("provider-contracts-json").textContent = pp(body);
        await refreshProviderData();
      } catch (e) {
        alert(e.message);
      }
    };

    $("btn-provider-refresh").onclick = async () => {
      try { await refreshProviderData(); } catch (e) { alert(e.message); }
    };

    $("btn-market-jobs-refresh").onclick = async () => {
      try { await refreshMarketJobs(); } catch (e) { showToast("Ошибка: " + e.message, "err"); }
    };

    $("btn-ingestion-refresh").onclick = async () => {
      try {
        await refreshIngestionDetails();
      } catch (e) {
        $("ingestion-json").textContent = e.message;
      }
    };

    $("btn-ingestion-manifest").onclick = async () => {
      try {
        const contractId = requireNonEmpty($("ingestion-contract-id").value, "Контракт");
        const totalUnits = requirePositiveInt($("ingestion-total-units").value, "Общий объем");
        const chunkSize = requirePositiveInt($("ingestion-chunk-size").value, "Размер чанка");
        const raw = $("ingestion-artifacts-json").value.trim();
        if (!raw) throw new Error("Заполните dataset_artifacts JSON");
        const datasetArtifacts = JSON.parse(raw);
        const { body } = await api(
          `/provider/contracts/${encodeURIComponent(contractId)}/ingestion/manifest`,
          {
            method: "POST",
            payload: {
              total_units: totalUnits,
              dataset_artifacts: datasetArtifacts,
              chunking: { strategy: "partition", chunk_unit: "rows", chunk_size: chunkSize },
            },
          }
        );
        $("ingestion-json").textContent = pp(body);
        showToast("Manifest и chunk plan сохранены.", "ok");
      } catch (e) {
        $("ingestion-json").textContent = e.message;
      }
    };

    $("btn-ingestion-upload").onclick = async () => {
      try {
        const contractId = requireNonEmpty($("ingestion-contract-id").value, "Контракт");
        const chunkSize = requirePositiveInt($("ingestion-chunk-size").value, "Размер чанка");
        const files = Array.from(($("ingestion-files").files || []));
        if (!files.length) throw new Error("Выберите хотя бы один файл");
        const { body } = await uploadApi(
          `/provider/contracts/${encodeURIComponent(contractId)}/ingestion/upload`,
          {
            files,
            form: { chunk_size: chunkSize, chunk_unit: "rows" },
            retries: 1,
          }
        );
        $("ingestion-json").textContent = pp(body);
        showToast("Файлы загружены, план рассчитан автоматически.", "ok");
      } catch (e) {
        $("ingestion-json").textContent = e.message;
      }
    };

    $("btn-ingestion-publish").onclick = async () => {
      try {
        const contractId = requireNonEmpty($("ingestion-contract-id").value, "Контракт");
        const { body } = await api(
          `/provider/contracts/${encodeURIComponent(contractId)}/ingestion/publish`,
          { method: "POST", payload: {} }
        );
        $("ingestion-json").textContent = pp(body);
        showToast("Chunk plan опубликован.", "ok");
      } catch (e) {
        $("ingestion-json").textContent = e.message;
      }
    };

    $("btn-model1-bootstrap").onclick = async () => {
      try {
        const sourcePath = $("model1-source-path").value.trim();
        const { body } = await api("/provider/model1/bootstrap", {
          method: "POST",
          payload: { source_path: sourcePath || null },
        });
        $("ingestion-json").textContent = pp(body);
        const contractId = (body.contract || {}).contract_id;
        if (contractId) $("ingestion-contract-id").value = contractId;
        showToast("Model_1 подготовлен.", "ok");
        await refreshProviderData();
      } catch (e) {
        $("ingestion-json").textContent = e.message;
      }
    };

    async function contractStatusUpdate(status) {
      const contractId = $("manage-contract-id").value;
      const { body } = await api(`/provider/contracts/${encodeURIComponent(contractId)}/status`, {
        method: "POST",
        payload: { status },
      });
      $("manage-contract-json").textContent = pp(body);
      await refreshProviderData();
    }

    $("btn-contract-status-active").onclick = async () => {
      try { await contractStatusUpdate("active"); } catch (e) { $("manage-contract-json").textContent = e.message; }
    };

    $("btn-contract-status-paused").onclick = async () => {
      try { await contractStatusUpdate("paused"); } catch (e) { $("manage-contract-json").textContent = e.message; }
    };

    $("btn-contract-status-closed").onclick = async () => {
      try { await contractStatusUpdate("closed"); } catch (e) { $("manage-contract-json").textContent = e.message; }
    };

    $("btn-contract-fund").onclick = async () => {
      try {
        const contractId = $("manage-contract-id").value;
        const amount = requirePositiveInt($("fund-amount").value, "Сумма пополнения");
        const { body } = await api(`/provider/contracts/${encodeURIComponent(contractId)}/fund`, {
          method: "POST",
          payload: {
            amount,
            currency: $("fund-currency").value,
          },
          retries: 2,
        });
        $("manage-contract-json").textContent = pp(body);
        await refreshProviderData();
        await refreshWallet();
      } catch (e) {
        $("manage-contract-json").textContent = e.message;
      }
    };

    $("btn-contract-refund").onclick = async () => {
      try {
        const contractId = $("manage-contract-id").value;
        const rawAmount = $("refund-amount").value.trim();
        const payload = rawAmount ? { amount: Number(rawAmount) } : {};
        const { body } = await api(`/provider/contracts/${encodeURIComponent(contractId)}/refund`, {
          method: "POST",
          payload,
        });
        $("manage-contract-json").textContent = pp(body);
        await refreshProviderData();
        await refreshWallet();
      } catch (e) {
        $("manage-contract-json").textContent = e.message;
      }
    };

    $("btn-results-live").onclick = async () => {
      try {
        const contractId = requireNonEmpty($("manage-contract-id").value, "Контракт");
        const { body } = await api(`/provider/contracts/${encodeURIComponent(contractId)}/results`);
        $("results-json").textContent = pp(body);
      } catch (e) {
        $("results-json").textContent = e.message;
      }
    };

    $("btn-results-finalize").onclick = async () => {
      try {
        const contractId = requireNonEmpty($("manage-contract-id").value, "Контракт");
        const { body } = await api(`/provider/contracts/${encodeURIComponent(contractId)}/results/finalize`, {
          method: "POST",
          payload: {},
        });
        $("results-json").textContent = pp(body);
        showToast("Итоговый снимок зафиксирован.", "ok");
      } catch (e) {
        $("results-json").textContent = e.message;
      }
    };

    $("btn-results-download").onclick = async () => {
      try {
        const contractId = requireNonEmpty($("manage-contract-id").value, "Контракт");
        const res = await fetch(`/provider/contracts/${encodeURIComponent(contractId)}/results/download`, {
          method: "GET",
          headers: { ...authHeaders() },
        });
        if (!res.ok) {
          let body = {};
          try { body = await res.json(); } catch {}
          throw new Error(toUserError(body, `Ошибка скачивания (${res.status})`));
        }
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${contractId}-results.zip`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        showToast("ZIP с итогами скачан.", "ok");
      } catch (e) {
        $("results-json").textContent = e.message;
      }
    };

    $("btn-wallet-refresh").onclick = async () => {
      try {
        await refreshWallet();
      } catch (e) {
        $("wallet-status").textContent = "Ошибка: " + e.message;
      }
    };

    $("btn-topup").onclick = async () => {
      try {
        const amount = requirePositiveInt($("topup-amount").value, "Сумма пополнения");
        await api("/market/wallet/topup", {
          method: "POST",
          payload: {
            currency: $("topup-currency").value,
            amount,
          },
        });
        $("btn-wallet-refresh").click();
      } catch (e) {
        alert(e.message);
      }
    };

    $("btn-convert").onclick = async () => {
      try {
        const amount = requirePositiveInt($("convert-amount").value, "Сумма конвертации");
        const { body } = await api("/market/convert", {
          method: "POST",
          payload: {
            from_currency: $("convert-from").value,
            to_currency: $("convert-to").value,
            amount,
            country_code: $("convert-country").value.trim() || null,
          },
          retries: 2,
        });
        const msg = `Конвертация выполнена: ${body.source_amount ?? amount} ${body.from_currency || ""} → ${body.target_amount ?? 0} ${body.to_currency || ""}`;
        $("convert-status").textContent = msg;
        $("convert-json").textContent = pp(body);
        $("btn-wallet-refresh").click();
      } catch (e) {
        $("convert-status").textContent = "Ошибка: " + e.message;
        $("convert-json").textContent = e.message;
      }
    };

    $("btn-withdraw").onclick = async () => {
      try {
        const amount = requirePositiveInt($("wd-amount").value, "Сумма вывода");
        const cardNumber = requireNonEmpty($("wd-card").value, "Номер карты");
        const { body } = await api("/market/withdrawals", {
          method: "POST",
          payload: {
            currency: $("wd-currency").value,
            amount,
            card_number: cardNumber,
            country_code: $("wd-country").value.trim() || null,
          },
          retries: 2,
        });
        $("withdraw-json").textContent = pp(body);
        $("btn-wallet-refresh").click();
      } catch (e) {
        $("withdraw-json").textContent = e.message;
      }
    };

    $("btn-withdraw-list").onclick = async () => {
      try {
        const { body } = await api("/market/withdrawals");
        $("withdraw-list-json").textContent = pp(body);
      } catch (e) {
        $("withdraw-list-json").textContent = e.message;
      }
    };

    $("btn-compliance-evaluate").onclick = async () => {
      try {
        const { body } = await api("/compliance/evaluate", {
          method: "POST",
          payload: {
            operation: $("cmp-op").value.trim(),
            amount: Number($("cmp-amount").value),
            currency: $("cmp-currency").value,
            country_code: $("cmp-country").value.trim() || null,
          },
        });
        $("compliance-json").textContent = pp(body);
      } catch (e) {
        $("compliance-json").textContent = e.message;
      }
    };

    $("btn-gov-info").onclick = async () => {
      try {
        await refreshGovernance();
      } catch (e) {
        $("gov-json").textContent = e.message;
      }
    };

    $("btn-admit-validator").onclick = async () => {
      try {
        const admissionToken = $("gov-admission-token").value.trim();
        const payload = { validator_client_id: $("val-id").value.trim() };
        if (admissionToken) payload.admission_token = admissionToken;
        const { body } = await api("/network/governance/validators/admit", {
          method: "POST",
          payload,
        });
        $("val-admit-json").textContent = pp(body);
      } catch (e) {
        $("val-admit-json").textContent = e.message;
      }
    };

    $("btn-gov-admit-node").onclick = async () => {
      try {
        const nodeId = $("gov-node-id").value.trim();
        if (!nodeId) throw new Error("Введите ID узла");
        const admissionToken = $("gov-admission-token").value.trim();
        const payload = { node_id: nodeId, meta: {} };
        if (admissionToken) payload.admission_token = admissionToken;
        const { body } = await api("/network/governance/admission", {
          method: "POST",
          payload,
        });
        $("gov-admit-node-json").textContent = pp(body);
        await refreshGovernance();
      } catch (e) {
        $("gov-admit-node-json").textContent = e.message;
      }
    };

    $("btn-gov-rollout-propose").onclick = async () => {
      try {
        const version = $("gov-rollout-version").value;
        const requiredAcks = Number($("gov-rollout-required-acks").value);
        if (!version) throw new Error("Выберите версию протокола");
        const { body } = await api("/network/governance/rollout/propose", {
          method: "POST",
          payload: {
            protocol_version: version,
            required_acks: requiredAcks,
          },
        });
        $("gov-rollout-json").textContent = pp(body);
        await refreshGovernance();
      } catch (e) {
        $("gov-rollout-json").textContent = e.message;
      }
    };

    $("btn-gov-rollout-ack").onclick = async () => {
      try {
        const { body } = await api("/network/governance/rollout/ack", {
          method: "POST",
          payload: {},
        });
        $("gov-rollout-json").textContent = pp(body);
        await refreshGovernance();
      } catch (e) {
        $("gov-rollout-json").textContent = e.message;
      }
    };

    $("btn-gov-rollout-finalize").onclick = async () => {
      try {
        const { body } = await api("/network/governance/rollout/finalize", {
          method: "POST",
          payload: {},
        });
        $("gov-rollout-json").textContent = pp(body);
        await refreshGovernance();
      } catch (e) {
        $("gov-rollout-json").textContent = e.message;
      }
    };

    $("btn-claims-refresh").onclick = async () => {
      try {
        const { body } = await api("/demo/claims");
        $("claims-json").textContent = pp(body);
      } catch (e) {
        $("claims-json").textContent = e.message;
      }
    };

    $("btn-demo-script-refresh").onclick = async () => {
      try {
        const { body } = await api("/demo/script");
        $("demo-script-json").textContent = pp(body);
      } catch (e) {
        $("demo-script-json").textContent = e.message;
      }
    };

    $("btn-demo-seed").onclick = async () => {
      try {
        const { body } = await api("/demo/seed", { method: "POST", payload: {} });
        $("demo-seed-json").textContent = pp(body);
        showToast("Demo-данные подготовлены.", "ok");
        await refreshProviderData();
      } catch (e) {
        $("demo-seed-json").textContent = e.message;
      }
    };

    $("btn-verdict-submit").onclick = async () => {
      try {
        const group = $("verdict-group").value.trim();
        const { body } = await api(`/replication/${encodeURIComponent(group)}/verdict`, {
          method: "POST",
          payload: {
            decision: $("verdict-value").value,
            reason: $("verdict-note").value.trim(),
          },
        });
        $("verdict-json").textContent = pp(body);
      } catch (e) {
        $("verdict-json").textContent = e.message;
      }
    };

    async function boot() {
      setupTabs();
      applyExpertMode();
      renderSession();
      renderProfile({});
      renderJobsDashboard({ jobs: [] });
      renderDevicesDashboard({ devices: [] });
      renderProviderCasesTable({ cases: [] });
      renderProviderWebhooksTable({ events: [] });
      renderFxOraclesTable({ scores: [] });
      renderPaymentsOpsTable({ operations: [] });
      renderReconcileTable({ reports: [] });
      setComputeTaskCard(null);
      $("compute-last-reward").textContent = "-";
      if (!$("ingestion-artifacts-json").value.trim()) {
        $("ingestion-artifacts-json").value = '[{"name":"dataset.parquet","uri":"s3://demo/dataset.parquet","sha256":"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa","size_bytes":1024}]';
      }
      if (!$("model1-source-path").value.trim()) {
        $("model1-source-path").value = "C:\\Users\\Alexandra\\Downloads\\benchPEP\\benchPEP.tpr";
      }
      initComputationTypes();
      await checkNode();
      if (state.auth.api_key) {
        try {
          await initTaskClasses();
          await initWorkloadPresets();
          await refreshProviderData();
          await refreshWallet();
          await refreshTreasury();
          await refreshGovernance();
          await refreshProfile();
          await refreshFxOracles();
          await refreshFxEpoch();
          await refreshPaymentsOps();
          await refreshReconcileReports();
          await refreshExplorerSummary();
          await refreshProviderCases();
          await refreshProviderWebhooks();
          await refreshWorkerProgress();
          await refreshMyDevices();
          await refreshMyJobs();
          const claims = await api("/demo/claims");
          $("claims-json").textContent = pp(claims.body);
          const script = await api("/demo/script");
          $("demo-script-json").textContent = pp(script.body);
        } catch {}
      }
    }

    boot();
  </script>
</body>
</html>
