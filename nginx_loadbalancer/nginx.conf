# Балансировщик нагрузки для узлов оркестратора.
# Операции с аккаунтом и балансом всегда идут на node_1 — тогда воркер (тоже на node_1) и проверка баланса видят одни данные.
# Остальные запросы (контракты, цепочка, дашборд) распределяются по узлам (ip_hash).
upstream orchestrator {
    ip_hash;
    server orchestrator_node_1:5000 max_fails=2 fail_timeout=30s;
    server orchestrator_node_2:5000 max_fails=2 fail_timeout=30s;
}

upstream node1_only {
    server orchestrator_node_1:5000 max_fails=2 fail_timeout=30s;
}

server {
    listen 80;
    server_name _;

    # Аккаунт и баланс — всегда node_1 (воркер тоже шлёт на node_1, токены начисляются там)
    location /me { proxy_pass http://node1_only; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_connect_timeout 5s; proxy_read_timeout 30s; proxy_send_timeout 30s; }
    location ~ ^/get_balance/ { proxy_pass http://node1_only; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_connect_timeout 5s; proxy_read_timeout 30s; proxy_send_timeout 30s; }
    location /auth/ { proxy_pass http://node1_only; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_connect_timeout 5s; proxy_read_timeout 30s; proxy_send_timeout 30s; proxy_request_buffering off; client_max_body_size 64k; }
    location /run_worker { proxy_pass http://node1_only; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_connect_timeout 5s; proxy_read_timeout 60s; proxy_send_timeout 60s; proxy_request_buffering off; client_max_body_size 1m; }
    location /submit_work { proxy_pass http://node1_only; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_connect_timeout 5s; proxy_read_timeout 60s; proxy_send_timeout 60s; proxy_request_buffering off; client_max_body_size 2m; }
    location /get_task { proxy_pass http://node1_only; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_connect_timeout 5s; proxy_read_timeout 30s; proxy_send_timeout 30s; }
    location /register { proxy_pass http://node1_only; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_connect_timeout 5s; proxy_read_timeout 30s; proxy_send_timeout 30s; }
    # Прогресс воркера: воркер пишет на node_1, дашборд должен читать с того же узла
    location /worker_progress { proxy_pass http://node1_only; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_connect_timeout 5s; proxy_read_timeout 30s; proxy_send_timeout 30s; proxy_request_buffering off; client_max_body_size 4k; }

    location / {
        proxy_pass http://orchestrator;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_connect_timeout 5s;
        proxy_read_timeout 60s;
        proxy_send_timeout 60s;
    }
}
