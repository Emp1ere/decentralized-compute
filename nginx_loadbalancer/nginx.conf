# Балансировщик нагрузки для узлов оркестратора.
# Для децентрализации все публичные эндпоинты распределяются по узлам (ip_hash).
upstream orchestrator {
    ip_hash;
    server orchestrator_node_1:5000 max_fails=2 fail_timeout=30s;
    server orchestrator_node_2:5000 max_fails=2 fail_timeout=30s;
    server orchestrator_node_3:5000 max_fails=2 fail_timeout=30s;
}

server {
    listen 80;
    server_name _;
    client_max_body_size 2048m;

    # Децентрализация: запросы распределяются между узлами.
    location /me { proxy_pass http://orchestrator; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_connect_timeout 5s; proxy_read_timeout 30s; proxy_send_timeout 30s; }
    location ~ ^/get_balance/ { proxy_pass http://orchestrator; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_connect_timeout 5s; proxy_read_timeout 30s; proxy_send_timeout 30s; }
    location /auth/ { proxy_pass http://orchestrator; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_connect_timeout 5s; proxy_read_timeout 30s; proxy_send_timeout 30s; proxy_request_buffering off; client_max_body_size 64k; }
    location /run_worker { proxy_pass http://orchestrator; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_connect_timeout 5s; proxy_read_timeout 60s; proxy_send_timeout 60s; proxy_request_buffering off; client_max_body_size 1m; }
    location /submit_work { proxy_pass http://orchestrator; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_connect_timeout 5s; proxy_read_timeout 900s; proxy_send_timeout 900s; proxy_request_buffering off; client_max_body_size 2m; }
    location /get_task { proxy_pass http://orchestrator; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_connect_timeout 5s; proxy_read_timeout 30s; proxy_send_timeout 30s; }
    location /register { proxy_pass http://orchestrator; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_connect_timeout 5s; proxy_read_timeout 30s; proxy_send_timeout 30s; }
    location /worker_progress { proxy_pass http://orchestrator; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_connect_timeout 5s; proxy_read_timeout 30s; proxy_send_timeout 30s; proxy_request_buffering off; client_max_body_size 4k; }
    location ~ ^/provider/contracts/[^/]+/ingestion/upload$ { proxy_pass http://orchestrator; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_connect_timeout 5s; proxy_read_timeout 300s; proxy_send_timeout 300s; proxy_request_buffering off; client_max_body_size 2048m; }

    location / {
        proxy_pass http://orchestrator;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_connect_timeout 5s;
        proxy_read_timeout 60s;
        proxy_send_timeout 60s;
    }
}
