# Анализ уязвимостей архитектуры PoUW

## Дата анализа
2026-02-05

## Консенсус
**Proof-of-Useful-Work (PoUW)** — блок создаётся при верифицированной полезной работе (submit_work).

---

## Выявленные уязвимости

### 1. Централизация создания блоков ⚠️ КРИТИЧНО

**Проблема:**
- Блок создаёт только узел, принявший `submit_work`
- Если все воркеры идут на один узел (через балансировщик или напрямую), этот узел создаёт все блоки
- Нарушение децентрализации

**Сценарий атаки:**
1. Злоумышленник направляет все запросы на один узел (обход балансировщика)
2. Этот узел становится единственным создателем блоков
3. Возможна цензура транзакций или манипуляция

**Риск:** Высокий

**Рекомендации:**
- Добавить механизм ротации создания блоков между узлами
- Или вернуться к PoW, где оба узла конкурируют за блок
- Или добавить "лидер-ротацию" на основе хеша блока/времени

---

### 2. Race condition при одновременных submit_work ⚠️ ВЫСОКИЙ

**Проблема:**
- Два узла могут одновременно получить `submit_work` от разных воркеров
- Оба создают блоки с одинаковым индексом → форк
- Синхронизация через `receive_block` происходит асинхронно

**Сценарий:**
```
T0: Узел A получает submit_work_1 → создаёт блок N
T0: Узел B получает submit_work_2 → создаёт блок N (тот же индекс!)
T1: Узел A отправляет блок N пиру B
T1: Узел B отправляет блок N пиру A
T2: Оба узла имеют разные блоки N → форк
T3: Через periodic_sync (30 сек) один из блоков откатывается
```

**Риск:** Высокий при высокой нагрузке

**Рекомендации:**
- Добавить блокировку (lock) при создании блока
- Или синхронизировать pending перед созданием блока
- Или добавить механизм "предварительного резервирования" индекса блока

---

### 3. Отсутствие блокировки при создании блока ⚠️ ВЫСОКИЙ

**Проблема:**
- Нет механизма, предотвращающего одновременное создание блоков
- Flask обрабатывает запросы в разных потоках → возможна гонка

**Риск:** Высокий

**Рекомендации:**
- Добавить `threading.Lock()` вокруг `mine_pending_transactions`
- Или использовать очередь задач с одним потоком-создателем блоков

---

### 4. Проблема с pending транзакциями ⚠️ СРЕДНИЙ

**Проблема:**
- При создании блока `pending` очищается локально
- Если два узла создают блоки одновременно, они могут включить разные транзакции
- Нет синхронизации pending между узлами перед созданием блока

**Риск:** Средний

**Рекомендации:**
- Синхронизировать pending с пиром перед созданием блока
- Или вернуться к механизму PoW, где pending синхронизируется через `/add_pending_tx`

---

### 5. Слабая защита балансировщика ⚠️ СРЕДНИЙ

**Проблема:**
- `ip_hash` в nginx можно обойти через разные IP или прокси
- Злоумышленник может направлять все запросы на один узел

**Риск:** Средний

**Рекомендации:**
- Добавить проверку распределения нагрузки между узлами
- Мониторинг: если один узел создаёт >80% блоков — предупреждение
- Или использовать более сложный алгоритм балансировки (least connections, weighted)

---

### 6. Отсутствие механизма выбора "главного" блока при форке ⚠️ СРЕДНИЙ

**Проблема:**
- При одновременных блоках выбор только по longest chain
- При одинаковой длине нет критерия (timestamp, hash, и т.д.)

**Риск:** Средний

**Рекомендации:**
- Добавить правило: при одинаковой длине выбирать блок с меньшим timestamp
- Или выбирать блок с меньшим хешем (лексикографически)

---

### 7. Проблема с синхронизацией при высокой нагрузке ⚠️ НИЗКИЙ

**Проблема:**
- `periodic_sync` раз в 30 секунд может быть недостаточно при частом создании блоков
- Долгое расхождение цепочек

**Риск:** Низкий (но может усугубить другие проблемы)

**Рекомендации:**
- Уменьшить `SYNC_INTERVAL` до 5-10 секунд
- Или добавить синхронизацию сразу после приёма блока (push-синхронизация уже есть)

---

## Сравнение с альтернативными консенсусами

| Консенсус | Централизация | Race condition | Сложность |
|-----------|---------------|----------------|-----------|
| **PoUW (текущий)** | Высокая (только узел, принявший submit_work) | Высокий риск | Низкая |
| **PoW** | Низкая (оба узла конкурируют) | Низкий риск (первый блок выигрывает) | Средняя |
| **PoS** | Средняя (зависит от стейка) | Низкий риск | Высокая |

---

## Рекомендации по исправлению

### Краткосрочные (быстрые правки)

1. **Добавить блокировку при создании блока:**
   ```python
   _block_creation_lock = threading.Lock()
   
   def submit_work():
       # ...
       with _block_creation_lock:
           new_block = blockchain.mine_pending_transactions(None)
   ```

2. **Уменьшить SYNC_INTERVAL до 5-10 секунд**

3. **Добавить правило выбора блока при форке:**
   - При одинаковой длине выбирать блок с меньшим timestamp

### Среднесрочные (улучшения архитектуры)

1. **Синхронизация pending перед созданием блока:**
   - Перед `mine_pending_transactions` запросить pending у пира и объединить

2. **Мониторинг распределения блоков:**
   - Метрика: процент блоков, созданных каждым узлом
   - Предупреждение, если один узел создаёт >80% блоков

### Долгосрочные (изменение консенсуса)

1. **Рассмотреть возврат к PoW:**
   - Оба узла получают pending tx и конкурируют за блок
   - Первый найденный блок выигрывает
   - Решает проблему централизации

2. **Или гибридный подход:**
   - PoUW для создания блока при submit_work
   - Но добавить механизм ротации "лидера" между узлами
   - Например, лидер = узел с наименьшим хешем последнего блока

---

## Итоговая оценка рисков

| Уязвимость | Критичность | Вероятность | Влияние |
|------------|-------------|-------------|---------|
| Централизация | Высокая | Средняя | Высокое |
| Race condition | Высокая | Высокая | Среднее |
| Отсутствие блокировки | Высокая | Высокая | Среднее |
| Проблема с pending | Средняя | Средняя | Среднее |
| Балансировщик | Средняя | Низкая | Низкое |
| Выбор блока при форке | Средняя | Низкая | Низкое |
| Синхронизация | Низкая | Низкая | Низкое |

**Общий риск:** ⚠️ **ВЫСОКИЙ** — требуется исправление критических уязвимостей перед продакшеном.

---

## Статус исправлений

**Дата:** 2026-02-05

### Критические исправления внесены ✅

1. ✅ **Блокировка при создании блока** — добавлена `threading.Lock()` в `submit_work`
2. ✅ **Синхронизация pending** — добавлена `sync_pending_from_peer()` перед созданием блока
3. ✅ **Эндпоинт `/pending`** — добавлен для синхронизации pending транзакций
4. ✅ **Правило выбора блока при форке** — добавлено в `replace_chain_from_peer()` (timestamp → hash)
5. ✅ **Интервал синхронизации** — уменьшен до 10 секунд

**Тестирование:** ✅ Все тесты прошли успешно (33 passed)

### Остаётся исправить

- ⚠️ **Централизация создания блоков** — требует среднесрочного решения (ротация лидера)

**Обновлённый риск:** ⚠️ **СРЕДНИЙ** — критические уязвимости исправлены, остаётся проблема централизации.
